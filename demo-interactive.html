<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>YellowGrid Service Execution - Interactive Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    :root {
      --yellow: #ffcb32;
      --yellow-soft: #ffe9a8;
      --bg-dark: #070c12;
      --bg-card: #0f1722;
      --bg-panel: #111c2a;
      --border: rgba(255, 255, 255, 0.12);
      --text-main: #f5f7fb;
      --text-muted: #8b95a7;
      --accent-blue: #4ea8ff;
      --accent-green: #49d493;
      --accent-red: #ff6b6b;
      --accent-orange: #fbbf24;
      --accent-purple: #c084fc;
      --shadow: 0 25px 60px rgba(0, 0, 0, 0.45);
      --radius-lg: 22px;
      --radius-md: 16px;
      --radius-pill: 999px;
      --transition: 0.2s ease;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "Inter", "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: radial-gradient(circle at top, #18233a, #05070b 65%);
      color: var(--text-main);
      height: 100vh;
      overflow: hidden;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
    }

    .app-shell {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    /* Header */
    .app-header {
      background: rgba(15, 23, 42, 0.95);
      border-bottom: 1px solid var(--border);
      padding: 1rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }

    .app-header .logo {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .app-header .logo img {
      height: 40px;
    }

    .app-header h1 {
      font-size: 1.3rem;
    }

    .scenario-selector {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .scenario-selector select {
      padding: 0.5rem 1rem;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--bg-panel);
      color: var(--text-main);
      font-size: 0.9rem;
    }

    /* Metro Journey Layout */
    .metro-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .metro-line {
      background: var(--bg-panel);
      border-bottom: 2px solid var(--border);
      padding: 1.5rem 2rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      overflow-x: auto;
      flex-shrink: 0;
    }

    .metro-station {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-shrink: 0;
    }

    .station-dot {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--bg-card);
      border: 3px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
    }

    .station-dot:hover {
      border-color: var(--yellow);
      transform: scale(1.1);
    }

    .station-dot.completed {
      background: var(--accent-green);
      border-color: var(--accent-green);
      color: #fff;
    }

    .station-dot.active {
      background: var(--yellow);
      border-color: var(--yellow);
      color: #1a1a1a;
      box-shadow: 0 0 20px var(--yellow);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 20px var(--yellow); }
      50% { box-shadow: 0 0 30px var(--yellow), 0 0 50px rgba(255, 203, 50, 0.5); }
    }

    .station-label {
      position: absolute;
      top: 40px;
      left: 50%;
      transform: translateX(-50%);
      white-space: nowrap;
      font-size: 0.75rem;
      color: var(--text-muted);
      font-weight: 500;
    }

    .station-dot.active + .station-label {
      color: var(--yellow);
      font-weight: 700;
    }

    .station-line {
      width: 60px;
      height: 3px;
      background: var(--border);
      flex-shrink: 0;
    }

    .station-line.completed {
      background: var(--accent-green);
    }

    /* Journey Cards */
    .journey-stage {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: auto;
      padding: 2rem;
    }

    .journey-card {
      width: 100%;
      max-width: 1200px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      animation: slideIn 0.4s ease;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateX(50px); }
      to { opacity: 1; transform: translateX(0); }
    }

    /* Main Dashboard (kept for backward compatibility) */
    .dashboard {
      display: none;
    }

    .panel {
      background: var(--bg-dark);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    .panel-header {
      padding: 1.25rem 1.5rem;
      border-bottom: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.6);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .panel-header h2 {
      font-size: 1.1rem;
      margin-bottom: 0.3rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .panel-header p {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .panel-content {
      padding: 1.5rem;
      flex: 1;
    }

    /* Data Flow Panel */
    .data-flow-stage {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.25rem;
      margin-bottom: 1rem;
    }

    .data-flow-stage.active {
      border-color: var(--yellow);
      background: rgba(255, 203, 50, 0.05);
    }

    .stage-header {
      display: flex;
      align-items: center;
      gap: 0.8rem;
      margin-bottom: 1rem;
    }

    .stage-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.08);
      font-size: 1.2rem;
    }

    .stage-icon.active {
      background: var(--yellow);
      color: #1a1405;
    }

    .stage-title {
      flex: 1;
    }

    .stage-title h3 {
      font-size: 1rem;
      margin-bottom: 0.2rem;
    }

    .stage-title span {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .data-payload {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      padding: 1rem;
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 0.8rem;
      max-height: 300px;
      overflow-y: auto;
    }

    .data-payload .key {
      color: var(--accent-blue);
    }

    .data-payload .value {
      color: var(--accent-green);
    }

    .data-payload .string {
      color: var(--accent-orange);
    }

    /* Stakeholder View Panel */
    .stakeholder-view {
      background: var(--bg-panel);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1rem;
    }

    .view-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border);
    }

    .view-header h3 {
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }

    .role-badge {
      padding: 0.4rem 0.8rem;
      border-radius: var(--radius-pill);
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-weight: 600;
    }

    .role-operator {
      background: rgba(78, 168, 255, 0.15);
      color: var(--accent-blue);
    }

    .role-provider {
      background: rgba(251, 191, 36, 0.15);
      color: var(--accent-orange);
    }

    .role-crew {
      background: rgba(192, 132, 252, 0.15);
      color: var(--accent-purple);
    }

    .role-customer {
      background: rgba(73, 212, 147, 0.15);
      color: var(--accent-green);
    }

    .view-section {
      margin-bottom: 1.5rem;
    }

    .view-section h4 {
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-bottom: 0.8rem;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }

    .info-item {
      background: rgba(255, 255, 255, 0.03);
      padding: 0.8rem;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.06);
    }

    .info-item label {
      display: block;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-bottom: 0.3rem;
    }

    .info-item .value {
      font-size: 0.95rem;
      font-weight: 500;
    }

    .action-buttons {
      display: flex;
      gap: 0.8rem;
      flex-wrap: wrap;
    }

    .btn {
      padding: 0.7rem 1.2rem;
      border-radius: 10px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition);
      font-size: 0.9rem;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--yellow), #ffd86c);
      color: #1a1405;
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.08);
      color: var(--text-main);
      border: 1px solid rgba(255, 255, 255, 0.15);
    }

    .btn:hover {
      transform: translateY(-2px);
    }

    /* AI Intelligence Panel */
    .ai-insight {
      background: rgba(192, 132, 252, 0.08);
      border-left: 3px solid var(--accent-purple);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
    }

    .ai-insight-header {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      margin-bottom: 0.8rem;
    }

    .ai-insight-header i {
      color: var(--accent-purple);
    }

    .ai-insight-header strong {
      color: var(--accent-purple);
    }

    .ai-reasoning {
      font-size: 0.9rem;
      line-height: 1.6;
      margin-bottom: 0.8rem;
    }

    .ai-confidence {
      display: flex;
      align-items: center;
      gap: 0.8rem;
      font-size: 0.85rem;
    }

    .confidence-bar {
      flex: 1;
      height: 6px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
      overflow: hidden;
    }

    .confidence-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-purple), var(--accent-blue));
      transition: width 0.5s ease;
    }

    .metric-card {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 1rem;
      margin-bottom: 0.8rem;
    }

    .metric-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.8rem;
    }

    .metric-label {
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
    }

    .metric-value {
      font-size: 1.8rem;
      font-weight: 700;
    }

    .metric-value.risk-low { color: var(--accent-green); }
    .metric-value.risk-medium { color: var(--accent-orange); }
    .metric-value.risk-high { color: var(--accent-red); }

    .metric-factors {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
    }

    .factor-chip {
      padding: 0.3rem 0.7rem;
      border-radius: var(--radius-pill);
      font-size: 0.75rem;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.12);
    }

    /* Timeline */
    .timeline {
      position: relative;
      padding-left: 2rem;
    }

    .timeline::before {
      content: '';
      position: absolute;
      left: 8px;
      top: 0;
      bottom: 0;
      width: 2px;
      background: rgba(255, 255, 255, 0.1);
    }

    .timeline-item {
      position: relative;
      padding-bottom: 1.5rem;
    }

    .timeline-item::before {
      content: '';
      position: absolute;
      left: -1.55rem;
      top: 0.3rem;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      border: 2px solid var(--bg-dark);
    }

    .timeline-item.active::before {
      background: var(--yellow);
      box-shadow: 0 0 0 4px rgba(255, 203, 50, 0.2);
    }

    .timeline-item.completed::before {
      background: var(--accent-green);
    }

    .timeline-content {
      font-size: 0.9rem;
    }

    .timeline-content strong {
      display: block;
      margin-bottom: 0.2rem;
    }

    .timeline-content span {
      color: var(--text-muted);
      font-size: 0.8rem;
    }

    /* Responsive */
    @media (max-width: 1200px) {
      .dashboard {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto auto;
      }
      
      body {
        overflow-y: auto;
        height: auto;
      }

      .app-shell {
        height: auto;
      }
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.35rem 0.8rem;
      border-radius: var(--radius-pill);
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .status-pending {
      background: rgba(255, 255, 255, 0.08);
      color: var(--text-muted);
    }

    .status-ok {
      background: rgba(73, 212, 147, 0.15);
      color: var(--accent-green);
    }

    .status-nok {
      background: rgba(255, 107, 107, 0.15);
      color: var(--accent-red);
    }

    /* Mobile App Styles */
    .mobile-screen {
      background: #000;
      border-radius: 24px;
      padding: 1rem;
      box-shadow: 0 0 0 8px #1a1a1a, 0 30px 60px rgba(0, 0, 0, 0.8);
      max-width: 400px;
      margin: 0 auto;
    }

    .mobile-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      background: linear-gradient(135deg, #1a1a1a, #2a2a2a);
      border-radius: 16px 16px 0 0;
      margin: -1rem -1rem 1rem -1rem;
    }

    .mobile-status-bar {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .mobile-card {
      background: #1a1a1a;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 1.25rem;
      margin-bottom: 1rem;
    }

    .mobile-button {
      width: 100%;
      padding: 1rem;
      border-radius: 12px;
      border: none;
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 0.8rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .mobile-button-primary {
      background: linear-gradient(135deg, var(--yellow), #ffd86c);
      color: #1a1405;
    }

    .mobile-button-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-main);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    /* Operator Cockpit Styles */
    .cockpit-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .cockpit-card {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.02));
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 1.25rem;
    }

    .cockpit-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
    }

    .cockpit-metric {
      font-size: 2rem;
      font-weight: 700;
      line-height: 1;
      margin: 0.5rem 0;
    }

    .cockpit-label {
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
    }

    /* Email/SMS Mockup */
    .email-mockup {
      background: #fff;
      color: #1a1a1a;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .email-header {
      border-bottom: 2px solid #e5e5e5;
      padding-bottom: 1rem;
      margin-bottom: 1.5rem;
    }

    .email-body {
      line-height: 1.6;
      color: #333;
    }

    .email-button {
      display: inline-block;
      background: linear-gradient(135deg, var(--yellow), #ffd86c);
      color: #1a1405;
      padding: 1rem 2rem;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 600;
      margin: 1.5rem 0;
    }

    .sms-mockup {
      background: #1a1a1a;
      border-radius: 18px;
      padding: 1rem;
      max-width: 300px;
      margin: 1rem auto;
    }

    .sms-bubble {
      background: #2a7aff;
      color: #fff;
      border-radius: 18px;
      padding: 0.8rem 1.2rem;
      margin-bottom: 0.5rem;
      font-size: 0.95rem;
      line-height: 1.4;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <!-- Header -->
    <header class="app-header">
      <div class="logo">
        <img src="assets/yellowgrid-lockup.png" alt="YellowGrid" />
        <h1>Service Execution Dashboard</h1>
      </div>
      <div class="scenario-selector">
        <label for="scenarioSelect" style="font-size: 0.9rem; color: var(--text-muted);">Scenario:</label>
        <select id="scenarioSelect" onchange="dashboard.loadScenario(this.value)">
          <option value="">Select a scenario...</option>
          <option value="simple-install">Simple Installation</option>
          <option value="tv-quotation">TV + Quotation</option>
          <option value="package-deal">Package Deal</option>
          <option value="complex-project">Complex Project</option>
          <option value="rework">Rework & Warranty</option>
        </select>
        <button class="btn btn-secondary" onclick="dashboard.nextStep()" id="nextBtn">
          Next Step <i class="fas fa-arrow-right"></i>
        </button>
      </div>
    </header>

    <!-- Metro Journey Experience -->
    <main class="metro-container">
      <!-- Metro Line Navigation -->
      <div class="metro-line" id="metroLine">
        <!-- Stations will be rendered here -->
      </div>

      <!-- Journey Stage (Single Card View) -->
      <div class="journey-stage" id="journeyStage">
        <div class="journey-card" id="journeyCard">
          <p style="color: var(--text-muted); text-align: center; padding: 4rem;">
            Select a scenario to begin your journey
          </p>
        </div>
      </div>
    </main>
  </div>

  <script>
    (() => {
      // Scenario data
      const scenarios = {
        'simple-install': {
          name: 'Simple Installation',
          salesOrder: {
            orderId: 'SO-2025-9821',
            salesChannel: 'E-commerce',
            store: 'Online Store PT',
            storeCode: 'ONLPT-001',
            salesProjectId: 'PROJ-4421',
            leadId: 'LEAD-8832',
            opportunityId: 'OPP-2025-5521',
            salesman: 'Rita Fernandes',
            salesmanId: 'SALES-RF-042',
            salesmanEmail: 'rita.fernandes@yellowgrid.pt',
            orderDate: '2025-11-08T14:22:00Z',
            confirmationDate: '2025-11-08T14:25:33Z',
            customer: {
              customerId: 'CUST-12845',
              name: 'Ana Costa',
              firstName: 'Ana',
              lastName: 'Costa',
              email: 'ana.costa@email.pt',
              phone: '+351 912 345 678',
              alternatePhone: '+351 218 765 432',
              address: 'Rua do Horizonte 12, 1170-123 Lisboa',
              addressLine1: 'Rua do Horizonte 12',
              addressLine2: '3Âº Andar, Porta B',
              city: 'Lisboa',
              postalCode: '1170-123',
              region: 'Lisboa',
              country: 'Portugal',
              customerSince: '2023-04-15',
              tier: 'Standard',
              claimHistory: 0,
              lifetimeValue: 1850.00,
              preferredContact: 'email',
              language: 'pt-PT'
            },
            products: [
              { 
                lineId: 'LINE-001',
                sku: 'COOK-IND-5Z', 
                name: 'Induction Cooktop 5 zones', 
                brand: 'Bosch',
                model: 'PXX875D34E',
                category: 'Cooktops',
                quantity: 1, 
                unitPrice: 450.00, 
                discount: 0.00,
                tax: 103.50,
                totalPrice: 450.00,
                supplier: 'Bosch Portugal',
                supplierSKU: 'BSH-PXX875D34E',
                warehouse: 'WH-LISBOA-01',
                stockStatus: 'In Stock',
                deliveryDate: '2025-11-17',
                estimatedDeliveryTime: '14:00-18:00',
                deliveryMethod: 'Standard Shipping',
                trackingNumber: 'TRK-2025-PLT-9821',
                warranty: '24 months',
                installationRequired: true
              }
            ],
            services: [
              { 
                lineId: 'LINE-002',
                code: 'INST-COOKTOP', 
                name: 'Cooktop Installation', 
                description: 'Professional installation of induction cooktop including electrical connection and testing',
                category: 'Installation Services',
                quantity: 1, 
                unitPrice: 120.00,
                discount: 0.00,
                tax: 27.60, 
                totalPrice: 120.00, 
                scheduledDate: '2025-11-18', 
                timeSlot: '09:00-11:00',
                duration: 120,
                techniciansRequired: 1,
                skillLevel: 'Standard',
                equipmentNeeded: ['Multimeter', 'Basic tools'],
                safetyRequirements: ['Circuit breaker access', 'Ventilation']
              }
            ],
            totals: {
              subtotalProducts: 450.00,
              subtotalServices: 120.00,
              subtotal: 570.00,
              discounts: 0.00,
              taxProducts: 103.50,
              taxServices: 27.60,
              totalTax: 131.10,
              shippingCost: 0.00,
              total: 701.10,
              currency: 'EUR'
            },
            payment: {
              status: 'Paid',
              method: 'Credit Card',
              cardType: 'Visa',
              last4Digits: '4532',
              paidAmount: 701.10,
              paidDate: '2025-11-10T16:45:22Z',
              transactionId: 'TXN-2025-9821-CC',
              paymentGateway: 'Stripe',
              installments: 1,
              dueDate: null
            },
            linkedQuotation: null,
            linkedPreEstimation: null,
            linkedContracts: [],
            sellerNotes: 'Customer requested morning slot. Easy access to apartment. Building has elevator. Customer will be present during installation. Electrical panel is in kitchen.',
            internalNotes: 'Standard installation. No special requirements. Customer is tech-savvy.',
            specialInstructions: 'Please call customer 30 minutes before arrival.',
            priority: 'Normal',
            tags: ['e-commerce', 'new-customer', 'morning-slot']
          }
        },
        'tv-quotation': {
          name: 'TV & Quotation',
          salesOrder: {
            orderId: 'SO-2025-1201',
            salesChannel: 'In-store',
            store: 'Retail Lisbon Av. Liberdade',
            storeCode: 'RET-LIS-AVL',
            salesProjectId: 'PROJ-5512',
            leadId: 'LEAD-9043',
            opportunityId: 'OPP-2025-7812',
            salesman: 'JoÃ£o Silva',
            salesmanId: 'SALES-JS-128',
            salesmanEmail: 'joao.silva@yellowgrid.pt',
            orderDate: '2025-11-14T10:15:00Z',
            confirmationDate: '2025-11-14T10:22:18Z',
            customer: {
              customerId: 'CUST-08234',
              name: 'Diogo Martins',
              firstName: 'Diogo',
              lastName: 'Martins',
              email: 'diogo.m@company.pt',
              phone: '+351 918 765 432',
              alternatePhone: '+351 213 456 789',
              address: 'Av. Liberdade 90, 3Âº Esq, 1250-145 Lisboa',
              addressLine1: 'Av. Liberdade 90',
              addressLine2: '3Âº Andar, Esquerdo',
              city: 'Lisboa',
              postalCode: '1250-145',
              region: 'Lisboa',
              country: 'Portugal',
              customerSince: '2022-09-20',
              tier: 'Premium',
              claimHistory: 1,
              lifetimeValue: 8450.00,
              preferredContact: 'phone',
              language: 'pt-PT'
            },
            products: [],
            services: [
              { 
                lineId: 'LINE-001',
                code: 'TV-KITCHEN', 
                name: 'Technical Visit - Kitchen Assessment',
                description: 'On-site technical visit to assess kitchen renovation scope, measure space, and provide detailed quotation for appliance installation',
                category: 'Technical Visit',
                quantity: 1, 
                unitPrice: 80.00,
                discount: 0.00,
                tax: 18.40,
                totalPrice: 80.00, 
                scheduledDate: '2025-11-20', 
                timeSlot: '10:00-12:30',
                duration: 150,
                techniciansRequired: 1,
                skillLevel: 'Expert',
                equipmentNeeded: ['Laser measure', 'Tablet for quotation', 'Camera'],
                safetyRequirements: []
              }
            ],
            totals: {
              subtotalProducts: 0.00,
              subtotalServices: 80.00,
              subtotal: 80.00,
              discounts: 0.00,
              taxProducts: 0.00,
              taxServices: 18.40,
              totalTax: 18.40,
              shippingCost: 0.00,
              total: 98.40,
              currency: 'EUR'
            },
            payment: {
              status: 'Pending',
              method: 'Invoice',
              cardType: null,
              last4Digits: null,
              paidAmount: 0.00,
              paidDate: null,
              transactionId: null,
              paymentGateway: 'Invoice',
              installments: 1,
              dueDate: '2025-12-05'
            },
            linkedQuotation: 'QUOTE-2025-3301',
            linkedPreEstimation: 'PRE-EST-2025-1109',
            linkedContracts: [],
            sellerNotes: 'Customer interested in full kitchen renovation. High upsell potential for dishwasher, oven, and hood installation. Previous claim was minor (delivery delay) and resolved. Customer mentioned budget around â‚¬5000-7000 for complete renovation.',
            internalNotes: 'VIP customer - premium service required. Previous purchase was â‚¬3200 appliance package. Claim resolved with full satisfaction.',
            specialInstructions: 'Bring kitchen design catalog. Customer interested in smart appliances with home automation integration.',
            priority: 'High',
            tags: ['in-store', 'premium', 'upsell-opportunity', 'technical-visit', 'renovation']
          }
        }
      };

      // Workflow steps
      const steps = [
        {
          id: 'integration',
          name: 'Sales Integration',
          stakeholder: 'system',
          description: 'Kafka message from sales system'
        },
        {
          id: 'ai-analysis',
          name: 'AI Analysis',
          stakeholder: 'system',
          description: 'Enrichment and automation'
        },
        {
          id: 'operator-triage',
          name: 'Operator Triage',
          stakeholder: 'operator',
          description: 'Risk assessment and planning'
        },
        {
          id: 'contract',
          name: 'Contract',
          stakeholder: 'operator',
          description: 'Bundle and send contract'
        },
        {
          id: 'provider-match',
          name: 'Provider Matching',
          stakeholder: 'provider',
          description: 'Crew assignment and negotiation'
        },
        {
          id: 'go-gate',
          name: 'Go Execution',
          stakeholder: 'operator',
          description: 'Payment & delivery gate'
        },
        {
          id: 'execution',
          name: 'Execution',
          stakeholder: 'crew',
          description: 'On-site service delivery'
        },
        {
          id: 'wcf',
          name: 'WCF',
          stakeholder: 'customer',
          description: 'Customer acceptance'
        }
      ];

      let currentScenario = null;
      let currentStep = 0;

      const renderDataFlow = () => {
        if (!currentScenario) return;
        
        const so = scenarios[currentScenario].salesOrder;
        const step = steps[currentStep];

        let html = '';

        if (step.id === 'integration') {
          html = `
            <div class="data-flow-stage active">
              <div class="stage-header">
                <div class="stage-icon active">
                  <i class="fas fa-satellite-dish"></i>
                </div>
                <div class="stage-title">
                  <h3>Kafka Message Received</h3>
                  <span>From ${so.salesChannel} â€¢ ${so.store}</span>
                </div>
              </div>
              <div class="data-payload">
<pre>{
  <span class="key">"orderId"</span>: <span class="string">"${so.orderId}"</span>,
  <span class="key">"channel"</span>: <span class="string">"${so.salesChannel}"</span>,
  <span class="key">"store"</span>: <span class="string">"${so.store}"</span>,
  <span class="key">"salesProjectId"</span>: <span class="string">"${so.salesProjectId}"</span>,
  <span class="key">"leadId"</span>: <span class="string">"${so.leadId}"</span>,
  <span class="key">"salesman"</span>: <span class="string">"${so.salesman}"</span>,
  <span class="key">"customer"</span>: {
    <span class="key">"name"</span>: <span class="string">"${so.customer.name}"</span>,
    <span class="key">"email"</span>: <span class="string">"${so.customer.email}"</span>,
    <span class="key">"phone"</span>: <span class="string">"${so.customer.phone}"</span>,
    <span class="key">"address"</span>: <span class="string">"${so.customer.address}"</span>,
    <span class="key">"tier"</span>: <span class="string">"${so.customer.tier}"</span>,
    <span class="key">"claimHistory"</span>: <span class="value">${so.customer.claimHistory}</span>
  },
  <span class="key">"products"</span>: [${so.products.map(p => `
    {
      <span class="key">"sku"</span>: <span class="string">"${p.sku}"</span>,
      <span class="key">"name"</span>: <span class="string">"${p.name}"</span>,
      <span class="key">"quantity"</span>: <span class="value">${p.quantity}</span>,
      <span class="key">"unitPrice"</span>: <span class="value">${p.unitPrice}</span>,
      <span class="key">"deliveryDate"</span>: <span class="string">"${p.deliveryDate}"</span>
    }`).join(',')}
  ],
  <span class="key">"services"</span>: [${so.services.map(s => `
    {
      <span class="key">"code"</span>: <span class="string">"${s.code}"</span>,
      <span class="key">"name"</span>: <span class="string">"${s.name}"</span>,
      <span class="key">"scheduledDate"</span>: <span class="string">"${s.scheduledDate}"</span>,
      <span class="key">"timeSlot"</span>: <span class="string">"${s.timeSlot}"</span>
    }`).join(',')}
  ],
  <span class="key">"payment"</span>: {
    <span class="key">"status"</span>: <span class="string">"${so.payment.status}"</span>,
    <span class="key">"method"</span>: <span class="string">"${so.payment.method}"</span>,
    <span class="key">"total"</span>: <span class="value">${so.totals.total}</span>
  },
  <span class="key">"linkedQuotation"</span>: ${so.linkedQuotation ? `<span class="string">"${so.linkedQuotation}"</span>` : '<span class="value">null</span>'},
  <span class="key">"sellerNotes"</span>: <span class="string">"${so.sellerNotes}"</span>
}</pre>
              </div>
            </div>
          `;
        } else if (step.id === 'ai-analysis') {
          const riskLevel = so.customer.claimHistory > 0 || so.linkedQuotation ? 'MEDIUM' : 'LOW';
          const tvPotential = so.linkedQuotation || so.sellerNotes.includes('upsell') ? 'HIGH' : 'LOW';
          html = `
            <div class="data-flow-stage active">
              <div class="stage-header">
                <div class="stage-icon active">
                  <i class="fas fa-brain"></i>
                </div>
                <div class="stage-title">
                  <h3>AI Enrichment Output</h3>
                  <span>Computed fields added to service order</span>
                </div>
              </div>
              <div class="data-payload">
<pre>{
  <span class="key">"serviceOrderId"</span>: <span class="string">"SRV-${so.orderId.split('-')[2]}"</span>,
  <span class="key">"linkedSalesOrder"</span>: <span class="string">"${so.orderId}"</span>,
  <span class="key">"aiEnrichment"</span>: {
    <span class="key">"riskScore"</span>: <span class="value">${riskLevel === 'LOW' ? '23' : '67'}</span>,
    <span class="key">"riskLevel"</span>: <span class="string">"${riskLevel}"</span>,
    <span class="key">"riskFactors"</span>: [${riskLevel === 'MEDIUM' ? '"Previous claim", "Linked quotation"' : '"New customer", "Low complexity"'}],
    <span class="key">"tvPotential"</span>: <span class="string">"${tvPotential}"</span>,
    <span class="key">"tvReason"</span>: <span class="string">"${tvPotential === 'HIGH' ? 'Seller notes indicate upsell opportunity' : 'Single product, limited scope'}"</span>,
    <span class="key">"suggestedProject"</span>: ${so.salesProjectId ? `<span class="string">"${so.salesProjectId}"</span>` : '<span class="value">null</span>'},
    <span class="key">"suggestedPilote"</span>: <span class="string">"PL-LIA"</span>,
    <span class="key">"piloteReason"</span>: <span class="string">"Lowest workload (3 active orders)"</span>
  }
}</pre>
              </div>
            </div>
          `;
        } else if (step.id === 'operator-triage') {
          html = `
            <div class="data-flow-stage active">
              <div class="stage-header">
                <div class="stage-icon active">
                  <i class="fas fa-clipboard-check"></i>
                </div>
                <div class="stage-title">
                  <h3>Operator Actions Logged</h3>
                  <span>Control Tower updates</span>
                </div>
              </div>
              <div class="data-payload">
<pre>{
  <span class="key">"serviceOrderId"</span>: <span class="string">"SRV-${so.orderId.split('-')[2]}"</span>,
  <span class="key">"operatorActions"</span>: {
    <span class="key">"triageTimestamp"</span>: <span class="string">"2025-11-16T14:22:18Z"</span>,
    <span class="key">"operatorId"</span>: <span class="string">"OP-MARIA"</span>,
    <span class="key">"riskOverride"</span>: <span class="value">false</span>,
    <span class="key">"scheduleValidated"</span>: <span class="value">true</span>,
    <span class="key">"projectLinked"</span>: <span class="string">"${so.salesProjectId}"</span>,
    <span class="key">"piloteAssigned"</span>: <span class="string">"PL-LIA"</span>,
    <span class="key">"notes"</span>: <span class="string">"AI suggestions accepted. Schedule compliant with calendar rules."</span>
  }
}</pre>
              </div>
            </div>
          `;
        } else if (step.id === 'contract') {
          html = `
            <div class="data-flow-stage active">
              <div class="stage-header">
                <div class="stage-icon active">
                  <i class="fas fa-file-signature"></i>
                </div>
                <div class="stage-title">
                  <h3>Contract Bundle Created</h3>
                  <span>Sent to customer for signature</span>
                </div>
              </div>
              <div class="data-payload">
<pre>{
  <span class="key">"contractId"</span>: <span class="string">"CTR-2025-${Math.floor(Math.random()*9000)+1000}"</span>,
  <span class="key">"bundledOrders"</span>: [<span class="string">"SRV-${so.orderId.split('-')[2]}"</span>],
  <span class="key">"template"</span>: <span class="string">"Standard Installation"</span>,
  <span class="key">"totalValue"</span>: <span class="value">${so.totals.services}</span>,
  <span class="key">"status"</span>: <span class="string">"SENT"</span>,
  <span class="key">"sentAt"</span>: <span class="string">"2025-11-16T14:25:03Z"</span>,
  <span class="key">"autoSendDelay"</span>: <span class="value">7200</span>,
  <span class="key">"customerContact"</span>: {
    <span class="key">"email"</span>: <span class="string">"${so.customer.email}"</span>,
    <span class="key">"phone"</span>: <span class="string">"${so.customer.phone}"</span>
  }
}</pre>
              </div>
            </div>
          `;
        } else if (step.id === 'provider-match') {
          html = `
            <div class="data-flow-stage active">
              <div class="stage-header">
                <div class="stage-icon active">
                  <i class="fas fa-handshake"></i>
                </div>
                <div class="stage-title">
                  <h3>Provider Crews Matched</h3>
                  <span>3 crews notified â€¢ 4h response window</span>
                </div>
              </div>
              <div class="data-payload">
<pre>{
  <span class="key">"matchingRound"</span>: <span class="value">1</span>,
  <span class="key">"crews"</span>: [
    {
      <span class="key">"crewId"</span>: <span class="string">"CREW-A-01"</span>,
      <span class="key">"provider"</span>: <span class="string">"Provider L"</span>,
      <span class="key">"lead"</span>: <span class="string">"Rui Lopes"</span>,
      <span class="key">"capacity"</span>: <span class="string">"2 installers"</span>,
      <span class="key">"matchScore"</span>: <span class="value">92</span>,
      <span class="key">"sla"</span>: <span class="string">"T+48h"</span>,
      <span class="key">"responseDeadline"</span>: <span class="string">"2025-11-16T18:30:00Z"</span>
    },
    {
      <span class="key">"crewId"</span>: <span class="string">"CREW-B-03"</span>,
      <span class="key">"provider"</span>: <span class="string">"Provider F"</span>,
      <span class="key">"matchScore"</span>: <span class="value">85</span>
    }
  ],
  <span class="key">"negotiationLimit"</span>: <span class="value">3</span>
}</pre>
              </div>
            </div>
          `;
        } else if (step.id === 'go-gate') {
          html = `
            <div class="data-flow-stage active">
              <div class="stage-header">
                <div class="stage-icon active">
                  <i class="fas fa-shield"></i>
                </div>
                <div class="stage-title">
                  <h3>Go Execution Gate</h3>
                  <span>Prerequisites validation</span>
                </div>
              </div>
              <div class="data-payload">
<pre>{
  <span class="key">"serviceOrderId"</span>: <span class="string">"SRV-${so.orderId.split('-')[2]}"</span>,
  <span class="key">"gateChecks"</span>: {
    <span class="key">"paymentReceived"</span>: <span class="value">${so.payment.status === 'Paid' ? 'true' : 'false'}</span>,
    <span class="key">"deliveryConfirmed"</span>: <span class="value">true</span>,
    <span class="key">"contractSigned"</span>: <span class="value">true</span>,
    <span class="key">"crewAssigned"</span>: <span class="value">true</span>,
    <span class="key">"gateStatus"</span>: <span class="string">"${so.payment.status === 'Paid' ? 'GO' : 'BLOCKED'}"</span>
  },
  <span class="key">"validatedAt"</span>: <span class="string">"2025-11-17T20:00:00Z"</span>,
  <span class="key">"derogation"</span>: ${so.payment.status !== 'Paid' ? '<span class="value">true</span>' : '<span class="value">false</span>'}
}</pre>
              </div>
            </div>
          `;
        } else if (step.id === 'execution') {
          html = `
            <div class="data-flow-stage active">
              <div class="stage-header">
                <div class="stage-icon active">
                  <i class="fas fa-screwdriver-wrench"></i>
                </div>
                <div class="stage-title">
                  <h3>Execution Evidence</h3>
                  <span>Crew mobile app data</span>
                </div>
              </div>
              <div class="data-payload">
<pre>{
  <span class="key">"checkin"</span>: {
    <span class="key">"timestamp"</span>: <span class="string">"2025-11-18T09:03:22Z"</span>,
    <span class="key">"location"</span>: {
      <span class="key">"lat"</span>: <span class="value">38.7223</span>,
      <span class="key">"lon"</span>: <span class="value">-9.1393</span>
    },
    <span class="key">"crewLead"</span>: <span class="string">"Rui Lopes"</span>
  },
  <span class="key">"checklist"</span>: {
    <span class="key">"completed"</span>: <span class="value">4</span>,
    <span class="key">"total"</span>: <span class="value">4</span>
  },
  <span class="key">"evidence"</span>: {
    <span class="key">"photos"</span>: <span class="value">3</span>,
    <span class="key">"audioNotes"</span>: <span class="value">1</span>
  },
  <span class="key">"completedAt"</span>: <span class="string">"2025-11-18T10:47:15Z"</span>
}</pre>
              </div>
            </div>
          `;
        } else if (step.id === 'wcf') {
          html = `
            <div class="data-flow-stage active">
              <div class="stage-header">
                <div class="stage-icon active">
                  <i class="fas fa-user-check"></i>
                </div>
                <div class="stage-title">
                  <h3>WCF (Customer Acceptance)</h3>
                  <span>Final outcome</span>
                </div>
              </div>
              <div class="data-payload">
<pre>{
  <span class="key">"wcfId"</span>: <span class="string">"WCF-${Math.floor(Math.random()*9000)+1000}"</span>,
  <span class="key">"serviceOrderId"</span>: <span class="string">"SRV-${so.orderId.split('-')[2]}"</span>,
  <span class="key">"outcome"</span>: <span class="string">"SIGNED_NO_RESERVES"</span>,
  <span class="key">"signedAt"</span>: <span class="string">"2025-11-18T10:52:33Z"</span>,
  <span class="key">"signatureMethod"</span>: <span class="string">"Digital (Mobile App)"</span>,
  <span class="key">"customerNotes"</span>: <span class="string">"Perfect installation, crew very professional"</span>,
  <span class="key">"paymentRelease"</span>: {
    <span class="key">"status"</span>: <span class="string">"AUTHORIZED"</span>,
    <span class="key">"providerAmount"</span>: <span class="value">${so.totals.services * 0.75}</span>,
    <span class="key">"releaseDate"</span>: <span class="string">"2025-11-19"</span>
  }
}</pre>
              </div>
            </div>
          `;
        }

        document.getElementById('dataFlowPanel').innerHTML = html;
      };

      const renderStakeholderView = () => {
        if (!currentScenario) return;
        
        const so = scenarios[currentScenario].salesOrder;
        const step = steps[currentStep];

        let html = '';

        if (step.id === 'integration') {
          html = `
            <div class="stakeholder-view">
              <div class="view-header">
                <h3>
                  <i class="fas fa-server"></i> System
                </h3>
                <span class="role-badge" style="background: rgba(78, 168, 255, 0.15); color: var(--accent-blue);">AUTOMATED</span>
              </div>
              <div class="view-section">
                <h4>Processing Pipeline</h4>
                <div class="timeline">
                  <div class="timeline-item completed">
                    <div class="timeline-content">
                      <strong>Message received</strong>
                      <span>Kafka topic: sales.orders.created</span>
                    </div>
                  </div>
                  <div class="timeline-item completed">
                    <div class="timeline-content">
                      <strong>Schema validation</strong>
                      <span>All required fields present</span>
                    </div>
                  </div>
                  <div class="timeline-item active">
                    <div class="timeline-content">
                      <strong>Service order creation</strong>
                      <span>Mapping to internal model...</span>
                    </div>
                  </div>
                  <div class="timeline-item">
                    <div class="timeline-content">
                      <strong>AI enrichment</strong>
                      <span>Pending</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          `;
        } else if (step.id === 'ai-analysis') {
          html = `
            <div class="stakeholder-view">
              <div class="view-header">
                <h3>
                  <i class="fas fa-robot"></i> AI Engine
                </h3>
                <span class="role-badge" style="background: rgba(192, 132, 252, 0.15); color: var(--accent-purple);">AUTOMATED</span>
              </div>
              <div class="view-section">
                <h4>Analysis in Progress</h4>
                <div class="timeline">
                  <div class="timeline-item completed">
                    <div class="timeline-content">
                      <strong>Customer profile analysis</strong>
                      <span>Tier: ${so.customer.tier}, Claims: ${so.customer.claimHistory}</span>
                    </div>
                  </div>
                  <div class="timeline-item completed">
                    <div class="timeline-content">
                      <strong>Risk scoring</strong>
                      <span>Computed risk factors</span>
                    </div>
                  </div>
                  <div class="timeline-item active">
                    <div class="timeline-content">
                      <strong>Project matching</strong>
                      <span>Searching for related orders...</span>
                    </div>
                  </div>
                  <div class="timeline-item">
                    <div class="timeline-content">
                      <strong>Pilote recommendation</strong>
                      <span>Pending</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          `;
        } else if (step.id === 'operator-triage') {
          const riskLevel = so.customer.claimHistory > 0 ? 'MEDIUM' : 'LOW';
          html = `
            <div class="stakeholder-view">
              <div class="view-header">
                <h3>
                  <i class="fas fa-headset"></i> Control Tower Cockpit
                </h3>
                <span class="role-badge role-operator">MARIA SANTOS â€¢ OP-MARIA</span>
              </div>
              
              <div class="cockpit-grid">
                <div class="cockpit-card">
                  <div class="cockpit-card-header">
                    <span class="cockpit-label">Risk Score</span>
                    <i class="fas fa-${riskLevel === 'LOW' ? 'shield-check' : 'shield-exclamation'}" style="color: var(--accent-${riskLevel === 'LOW' ? 'green' : 'orange'}); font-size: 1.3rem;"></i>
                  </div>
                  <div class="cockpit-metric" style="color: var(--accent-${riskLevel === 'LOW' ? 'green' : 'orange'});">${riskLevel === 'LOW' ? '23' : '67'}</div>
                  <div style="font-size: 0.85rem; color: var(--text-muted);">
                    ${riskLevel === 'LOW' ? 'No red flags detected' : 'Previous claim + quotation'}
                  </div>
                </div>
                
                <div class="cockpit-card">
                  <div class="cockpit-card-header">
                    <span class="cockpit-label">Customer Tier</span>
                    <i class="fas fa-crown" style="color: var(--yellow); font-size: 1.3rem;"></i>
                  </div>
                  <div class="cockpit-metric">${so.customer.tier}</div>
                  <div style="font-size: 0.85rem; color: var(--text-muted);">
                    LTV: â‚¬${so.customer.lifetimeValue}
                  </div>
                </div>
                
                <div class="cockpit-card">
                  <div class="cockpit-card-header">
                    <span class="cockpit-label">Payment Status</span>
                    <i class="fas fa-${so.payment.status === 'Paid' ? 'circle-check' : 'clock'}" style="color: var(--accent-${so.payment.status === 'Paid' ? 'green' : 'orange'}); font-size: 1.3rem;"></i>
                  </div>
                  <div class="cockpit-metric" style="font-size: 1.3rem; color: var(--accent-${so.payment.status === 'Paid' ? 'green' : 'orange'});">${so.payment.status.toUpperCase()}</div>
                  <div style="font-size: 0.85rem; color: var(--text-muted);">
                    ${so.payment.status === 'Paid' ? `â‚¬${so.payment.paidAmount} via ${so.payment.method}` : `Due: ${so.payment.dueDate || 'N/A'}`}
                  </div>
                </div>
              </div>

              <div class="view-section">
                <h4 style="margin-bottom: 1rem;">ðŸ“‹ Service Order: SRV-${so.orderId.split('-')[2]}</h4>
                <div style="background: rgba(255, 255, 255, 0.03); border-radius: 12px; padding: 1.25rem; margin-bottom: 1rem;">
                  <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                    <div>
                      <div style="font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); margin-bottom: 0.3rem;">Customer</div>
                      <div style="font-weight: 600;">${so.customer.name}</div>
                      <div style="font-size: 0.85rem; color: var(--text-muted);">${so.customer.phone}</div>
                    </div>
                    <div>
                      <div style="font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); margin-bottom: 0.3rem;">Location</div>
                      <div style="font-weight: 600;">${so.customer.city}, ${so.customer.postalCode}</div>
                      <div style="font-size: 0.85rem; color: var(--text-muted);">${so.customer.addressLine1}</div>
                    </div>
                    <div>
                      <div style="font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); margin-bottom: 0.3rem;">Service</div>
                      <div style="font-weight: 600;">${so.services[0].name}</div>
                      <div style="font-size: 0.85rem; color: var(--text-muted);">${so.services[0].duration} min â€¢ ${so.services[0].skillLevel}</div>
                    </div>
                    <div>
                      <div style="font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); margin-bottom: 0.3rem;">Scheduled</div>
                      <div style="font-weight: 600;">${so.services[0].scheduledDate}</div>
                      <div style="font-size: 0.85rem; color: var(--text-muted);">${so.services[0].timeSlot}</div>
                    </div>
                  </div>
                </div>
                
                <div style="background: rgba(192, 132, 252, 0.08); border: 1px solid rgba(192, 132, 252, 0.3); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                  <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <i class="fas fa-robot" style="color: var(--accent-purple);"></i>
                    <strong style="color: var(--accent-purple);">AI Recommendations Accepted</strong>
                  </div>
                  <div style="font-size: 0.9rem;">âœ“ Pilote: PL-LIA (Lia Santos) â€¢ Load: 3 orders<br>âœ“ Schedule: Compliant (not Sunday, weekday AM)<br>âœ“ Project: Linked to ${so.salesProjectId}</div>
                </div>
              </div>

              <div class="view-section">
                <h4>Operator Actions</h4>
                <div style="display: flex; gap: 0.8rem; flex-wrap: wrap;">
                  <button class="btn btn-primary" style="flex: 1;">âœ“ Confirm & Proceed</button>
                  <button class="btn btn-secondary">Override Risk</button>
                  <button class="btn btn-secondary">Reschedule</button>
                  <button class="btn btn-secondary">Reassign Pilote</button>
                </div>
              </div>
            </div>
          `;
        } else if (step.id === 'contract') {
          html = `
            <div class="stakeholder-view">
              <div class="view-header">
                <h3>
                  <i class="fas fa-file-signature"></i> Customer Contract Signature
                </h3>
                <span class="role-badge role-customer">${so.customer.name.toUpperCase()}</span>
              </div>

              <div class="view-section">
                <h4 style="margin-bottom: 1rem;">ðŸ“§ Email Notification</h4>
                <div class="email-mockup">
                  <div class="email-header">
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                      <div style="background: var(--yellow); color: #1a1a1a; padding: 0.5rem 1rem; font-weight: 700; border-radius: 4px;">YellowGrid</div>
                      <div style="flex: 1;"></div>
                      <div style="font-size: 0.85rem; color: #666;">Just now</div>
                    </div>
                    <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.3rem;">
                      <strong>From:</strong> contracts@yellowgrid.pt
                    </div>
                    <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.3rem;">
                      <strong>To:</strong> ${so.customer.email}
                    </div>
                    <div style="font-size: 1.1rem; font-weight: 700; margin-top: 0.8rem;">
                      Service Contract Ready for Signature - Action Required
                    </div>
                  </div>
                  <div class="email-body">
                    <p>Dear ${so.customer.firstName},</p>
                    <p style="margin: 1rem 0;">
                      Your service contract for <strong>${so.services[0].name}</strong> is ready for digital signature.
                    </p>
                    <div style="background: #f8f9fa; border-left: 4px solid var(--yellow); padding: 1rem; margin: 1rem 0; color: #333;">
                      <strong style="color: #1a1a1a;">âš ï¸ Important:</strong> Your service cannot proceed until this contract is signed. Please review and sign within 48 hours to maintain your scheduled date.
                    </div>
                    <div style="text-align: center; margin: 1.5rem 0;">
                      <a href="#" class="email-button">
                        <i class="fas fa-file-signature"></i> Review & Sign Contract
                      </a>
                    </div>
                    <p style="margin: 1rem 0; font-size: 0.9rem; color: #666;">
                      <strong>Contract Summary:</strong><br>
                      Service Order: <strong>SRV-${so.orderId.split('-')[2]}</strong><br>
                      Total Amount: <strong>â‚¬${so.totals.services}</strong><br>
                      Scheduled Date: <strong>${so.services[0].scheduledDate} at ${so.services[0].timeSlot}</strong><br>
                      Payment: <strong>${so.payment.status}</strong>
                    </p>
                    <p style="margin: 1.5rem 0 0.5rem 0; font-size: 0.85rem; color: #999; border-top: 1px solid #e5e5e5; padding-top: 1rem;">
                      Questions? Contact us at contracts@yellowgrid.pt or +351 210 123 456
                    </p>
                  </div>
                </div>
              </div>

              <div class="view-section">
                <h4 style="margin-bottom: 1rem;">ðŸ“± SMS Notification</h4>
                <div class="sms-mockup">
                  <div style="text-align: center; color: var(--text-muted); font-size: 0.8rem; margin-bottom: 0.8rem;">
                    Today - Just now
                  </div>
                  <div class="sms-bubble">
                    YellowGrid: Your service contract is ready! Sign now to confirm your ${so.services[0].scheduledDate} appointment: yellowgrid.pt/contract/SRV-${so.orderId.split('-')[2]}
                  </div>
                </div>
              </div>

              <div class="view-section">
                <h4 style="margin-bottom: 1rem;">ðŸŒ Contract Signature Portal</h4>
                <div style="border: 2px solid var(--border); border-radius: 12px; padding: 1.5rem; background: rgba(255, 255, 255, 0.02); max-height: 600px; overflow-y: auto;">
                  <div style="text-align: center; margin-bottom: 1.5rem;">
                    <div style="display: inline-block; background: var(--yellow); color: #1a1a1a; padding: 0.5rem 1.5rem; font-weight: 700; border-radius: 4px; margin-bottom: 1rem;">YellowGrid</div>
                    <h3 style="font-size: 1.5rem; margin-bottom: 0.5rem;">Service Contract</h3>
                    <p style="color: var(--text-muted); font-size: 0.95rem;">Contract #CTR-${so.linkedContracts || so.orderId.split('-')[2]}</p>
                  </div>

                  <div style="background: rgba(255, 255, 255, 0.05); border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
                    <h4 style="margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">ðŸ“‹ Contract Summary</h4>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                      <div>
                        <div style="font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); margin-bottom: 0.3rem;">Service</div>
                        <div style="font-weight: 600;">${so.services[0].name}</div>
                      </div>
                      <div>
                        <div style="font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); margin-bottom: 0.3rem;">Scheduled Date</div>
                        <div style="font-weight: 600;">${so.services[0].scheduledDate}</div>
                      </div>
                      <div>
                        <div style="font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); margin-bottom: 0.3rem;">Time Slot</div>
                        <div style="font-weight: 600;">${so.services[0].timeSlot}</div>
                      </div>
                      <div>
                        <div style="font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); margin-bottom: 0.3rem;">Total Amount</div>
                        <div style="font-weight: 600; color: var(--yellow); font-size: 1.1rem;">â‚¬${so.totals.services}</div>
                      </div>
                    </div>
                  </div>

                  <div style="background: rgba(255, 255, 255, 0.05); border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
                    <h4 style="margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">ðŸ’° Pricing Breakdown</h4>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                      <span>Products</span>
                      <span style="font-weight: 600;">â‚¬${so.totals.products}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                      <span>Services</span>
                      <span style="font-weight: 600;">â‚¬${so.totals.services}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; color: var(--accent-green);">
                      <span>Discount</span>
                      <span style="font-weight: 600;">-â‚¬${so.totals.discount || '0.00'}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--text-muted);">
                      <span>Tax (${so.totals.taxRate || '23%'})</span>
                      <span>â‚¬${so.totals.tax}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--text-muted);">
                      <span>Shipping</span>
                      <span>â‚¬${so.totals.shippingCost || '0.00'}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding-top: 0.8rem; border-top: 2px solid var(--border); font-size: 1.2rem; font-weight: 700;">
                      <span>Total Amount</span>
                      <span style="color: var(--yellow);">â‚¬${so.totals.total}</span>
                    </div>
                  </div>

                  <div style="background: rgba(255, 255, 255, 0.05); border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
                    <h4 style="margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">ðŸ“œ Terms & Conditions</h4>
                    <div style="max-height: 200px; overflow-y: auto; font-size: 0.85rem; line-height: 1.6; color: var(--text-muted);">
                      <p style="margin-bottom: 0.8rem;"><strong>1. Service Agreement:</strong> YellowGrid commits to provide the services described above at the agreed date and time. Customer commits to provide access to the installation location.</p>
                      <p style="margin-bottom: 0.8rem;"><strong>2. Payment Terms:</strong> ${so.payment.status === 'Paid' ? 'Payment has been received and confirmed.' : 'Payment is due before service execution. Accepted methods: Credit Card, Bank Transfer, MB WAY.'}</p>
                      <p style="margin-bottom: 0.8rem;"><strong>3. Cancellation Policy:</strong> Free cancellation up to 48 hours before scheduled date. Cancellations within 48 hours incur a 50% fee. No-shows are charged 100%.</p>
                      <p style="margin-bottom: 0.8rem;"><strong>4. Rescheduling:</strong> Customer may reschedule once free of charge with 48h notice. Additional rescheduling requests may incur fees.</p>
                      <p style="margin-bottom: 0.8rem;"><strong>5. Warranty:</strong> All installed equipment comes with manufacturer warranty as specified. Service quality is guaranteed for 90 days.</p>
                      <p style="margin-bottom: 0.8rem;"><strong>6. Privacy:</strong> Customer data is processed according to GDPR regulations. See full privacy policy at yellowgrid.pt/privacy</p>
                      <p style="margin-bottom: 0.8rem;"><strong>7. Dispute Resolution:</strong> Any disputes will be resolved through Portuguese arbitration. Governing law: Portuguese Civil Code.</p>
                    </div>
                  </div>

                  <div style="background: rgba(78, 168, 255, 0.08); border: 1px solid rgba(78, 168, 255, 0.3); border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                    <label style="display: flex; align-items: flex-start; gap: 0.8rem; cursor: pointer;">
                      <input type="checkbox" style="width: 20px; height: 20px; margin-top: 0.2rem;">
                      <span style="flex: 1; font-size: 0.9rem;">
                        I have read and agree to the terms and conditions. I authorize YellowGrid to proceed with the service as described. I understand that payment authorization or prepayment may be required before service execution.
                      </span>
                    </label>
                  </div>

                  <div style="border: 2px dashed var(--border); border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem; text-align: center;">
                    <i class="fas fa-signature" style="font-size: 2rem; color: var(--yellow); margin-bottom: 0.5rem;"></i>
                    <div style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 1rem;">Digital Signature Area</div>
                    <div style="background: rgba(255, 255, 255, 0.05); padding: 1rem; border-radius: 4px; font-style: italic; font-size: 1.2rem;">
                      ${so.customer.name}
                    </div>
                    <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem;">
                      Signed electronically on ${new Date().toLocaleString('en-GB')}
                    </div>
                  </div>

                  <button class="btn btn-primary" style="width: 100%; padding: 1.2rem; font-size: 1.2rem; background: linear-gradient(135deg, var(--yellow), #f59e0b);">
                    <i class="fas fa-check-circle"></i> Sign Contract & Confirm Service
                  </button>

                  <div style="text-align: center; margin-top: 1rem;">
                    <a href="#" style="color: var(--accent-red); font-size: 0.9rem; text-decoration: none;">
                      <i class="fas fa-times-circle"></i> Decline Contract
                    </a>
                  </div>
                </div>
              </div>
            </div>
          `;
        } else if (step.id === 'provider-match') {
          html = `
            <div class="stakeholder-view">
              <div class="view-header">
                <h3>
                  <i class="fas fa-mobile-screen-button"></i> Provider Mobile App
                </h3>
                <span class="role-badge role-provider">PROVIDER L â€¢ RUI LOPES</span>
              </div>
              
              <div class="mobile-screen">
                <div class="mobile-header">
                  <div class="mobile-status-bar">
                    <i class="fas fa-signal"></i> 
                    <i class="fas fa-wifi"></i>
                    <span style="margin-left: 0.5rem;">9:41</span>
                  </div>
                  <div style="font-size: 1.2rem; font-weight: 700;">YellowGrid Pro</div>
                  <div><i class="fas fa-bell"></i></div>
                </div>

                <div class="mobile-card" style="background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #1a1405;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.8rem;">
                    <div style="font-size: 0.85rem; font-weight: 600; text-transform: uppercase;">New Assignment</div>
                    <div style="background: rgba(0,0,0,0.2); padding: 0.3rem 0.7rem; border-radius: 999px; font-size: 0.75rem; font-weight: 700;">
                      <i class="fas fa-clock"></i> 4h to respond
                    </div>
                  </div>
                  <div style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.3rem;">Match Score: 92/100</div>
                  <div style="font-size: 0.9rem; opacity: 0.9;">
                    <i class="fas fa-check-circle"></i> High priority â€¢ Perfect fit for your crew
                  </div>
                </div>

                <div class="mobile-card">
                  <div style="font-size: 0.85rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.8rem;">Service Details</div>
                  <div style="font-size: 1.1rem; font-weight: 700; margin-bottom: 1rem;">${so.services[0].name}</div>
                  
                  <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                    <div style="flex: 1;">
                      <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.3rem;">ðŸ“… DATE</div>
                      <div style="font-weight: 600;">${so.services[0].scheduledDate}</div>
                    </div>
                    <div style="flex: 1;">
                      <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.3rem;">ðŸ• TIME</div>
                      <div style="font-weight: 600;">${so.services[0].timeSlot}</div>
                    </div>
                  </div>

                  <div style="margin-bottom: 1rem;">
                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.3rem;">ðŸ“ LOCATION</div>
                    <div style="font-weight: 600;">${so.customer.city}</div>
                    <div style="font-size: 0.9rem; color: var(--text-muted);">${so.customer.addressLine1}</div>
                  </div>

                  <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                    <div style="background: rgba(78, 168, 255, 0.1); padding: 0.4rem 0.8rem; border-radius: 999px; font-size: 0.8rem;">
                      ${so.services[0].duration} min
                    </div>
                    <div style="background: rgba(78, 168, 255, 0.1); padding: 0.4rem 0.8rem; border-radius: 999px; font-size: 0.8rem;">
                      ${so.services[0].techniciansRequired} tech needed
                    </div>
                    <div style="background: rgba(78, 168, 255, 0.1); padding: 0.4rem 0.8rem; border-radius: 999px; font-size: 0.8rem;">
                      ${so.services[0].skillLevel}
                    </div>
                  </div>

                  <div style="background: rgba(73, 212, 147, 0.1); border-radius: 8px; padding: 0.8rem; font-size: 0.9rem;">
                    <strong style="color: var(--accent-green);"><i class="fas fa-check"></i> Your Crew Available</strong><br>
                    <span style="color: var(--text-muted);">Rui Lopes â€¢ 2 installers â€¢ SLA: T+48h</span>
                  </div>
                </div>

                <button class="mobile-button mobile-button-primary">
                  <i class="fas fa-check-circle"></i> Accept Assignment
                </button>
                <button class="mobile-button mobile-button-secondary">
                  <i class="fas fa-calendar-alt"></i> Propose Different Date
                </button>
                <button class="mobile-button mobile-button-secondary">
                  <i class="fas fa-times-circle"></i> Decline
                </button>
              </div>
            </div>
          `;
        } else if (step.id === 'go-gate') {
          html = `
            <div class="stakeholder-view">
              <div class="view-header">
                <h3>
                  <i class="fas fa-shield"></i> Go Execution Gate
                </h3>
                <span class="role-badge role-operator">MARIA SANTOS</span>
              </div>
              <div class="view-section">
                <h4>Gate Requirements</h4>
                <div class="timeline">
                  <div class="timeline-item ${so.payment.status === 'Paid' ? 'completed' : ''}">
                    <div class="timeline-content">
                      <strong>Payment Received</strong>
                      <span>${so.payment.status === 'Paid' ? 'Confirmed' : 'Pending'}</span>
                    </div>
                  </div>
                  <div class="timeline-item completed">
                    <div class="timeline-content">
                      <strong>Delivery Confirmed</strong>
                      <span>Materials on site</span>
                    </div>
                  </div>
                  <div class="timeline-item completed">
                    <div class="timeline-content">
                      <strong>Contract Signed</strong>
                      <span>Customer accepted</span>
                    </div>
                  </div>
                  <div class="timeline-item completed">
                    <div class="timeline-content">
                      <strong>Crew Assigned</strong>
                      <span>Rui Lopes crew ready</span>
                    </div>
                  </div>
                </div>
              </div>
              <div class="view-section">
                <h4>Gate Status</h4>
                <p style="font-size: 1.5rem; font-weight: 700; color: var(--accent-green); text-align: center; margin: 1rem 0;">
                  ${so.payment.status === 'Paid' ? 'âœ“ GO EXECUTION' : 'âš  BLOCKED'}
                </p>
                ${so.payment.status !== 'Paid' ? '<div class="action-buttons"><button class="btn btn-secondary">Authorize Derogation</button></div>' : ''}
              </div>
            </div>
          `;
        } else if (step.id === 'execution') {
          html = `
            <div class="stakeholder-view">
              <div class="view-header">
                <h3>
                  <i class="fas fa-mobile-screen-button"></i> Crew Mobile App
                </h3>
                <span class="role-badge role-crew">RUI LOPES</span>
              </div>
              <div class="view-section">
                <h4>Today's Job</h4>
                <div class="info-grid">
                  <div class="info-item">
                    <label>Customer</label>
                    <div class="value">${so.customer.name}</div>
                  </div>
                  <div class="info-item">
                    <label>Phone</label>
                    <div class="value">${so.customer.phone}</div>
                  </div>
                  <div class="info-item">
                    <label>Address</label>
                    <div class="value">${so.customer.address.split(',')[0]}</div>
                  </div>
                  <div class="info-item">
                    <label>Time</label>
                    <div class="value">${so.services[0].timeSlot}</div>
                  </div>
                </div>
              </div>
              
              <div class="mobile-screen">
                <div class="mobile-header">
                  <div class="mobile-status-bar">
                    <i class="fas fa-signal"></i> 
                    <i class="fas fa-wifi"></i>
                    <span style="margin-left: 0.5rem;">9:03</span>
                  </div>
                  <div style="font-size: 1.2rem; font-weight: 700;">Today's Job</div>
                  <div><i class="fas fa-ellipsis-v"></i></div>
                </div>

                <div class="mobile-card" style="background: linear-gradient(135deg, #49d493, #38a169); color: #fff;">
                  <div style="font-size: 0.85rem; font-weight: 600; text-transform: uppercase; margin-bottom: 0.5rem;">
                    <i class="fas fa-check-circle"></i> Checked In
                  </div>
                  <div style="font-size: 1.3rem; font-weight: 700; margin-bottom: 0.3rem;">Job #SRV-${so.orderId.split('-')[2]}</div>
                  <div style="font-size: 0.9rem; opacity: 0.9;">
                    Started at 09:03 â€¢ Est. completion: 11:00
                  </div>
                </div>

                <div class="mobile-card">
                  <div style="font-size: 0.85rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.8rem;">Customer Info</div>
                  <div style="font-size: 1.2rem; font-weight: 700; margin-bottom: 0.5rem;">${so.customer.name}</div>
                  <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <i class="fas fa-phone" style="color: var(--accent-blue);"></i>
                    <span style="font-weight: 600;">${so.customer.phone}</span>
                    <button style="margin-left: auto; background: var(--accent-blue); border: none; padding: 0.4rem 0.8rem; border-radius: 8px; color: #fff; font-size: 0.85rem;">
                      <i class="fas fa-phone"></i> Call
                    </button>
                  </div>
                  <div style="display: flex; align-items: flex-start; gap: 0.5rem;">
                    <i class="fas fa-map-marker-alt" style="color: var(--accent-blue); margin-top: 0.2rem;"></i>
                    <div>
                      <div style="font-weight: 600;">${so.customer.addressLine1}</div>
                      <div style="font-size: 0.9rem; color: var(--text-muted);">${so.customer.city}, ${so.customer.postalCode}</div>
                    </div>
                  </div>
                </div>

                <div class="mobile-card">
                  <div style="font-size: 0.85rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.8rem;">Work Checklist</div>
                  <div style="display: flex; flex-direction: column; gap: 0.8rem;">
                    <label style="display: flex; align-items: center; gap: 0.8rem; cursor: pointer;">
                      <input type="checkbox" checked style="width: 20px; height: 20px;">
                      <span style="flex: 1;">Verify customer identity & documents</span>
                      <i class="fas fa-check-circle" style="color: var(--accent-green);"></i>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.8rem; cursor: pointer;">
                      <input type="checkbox" checked style="width: 20px; height: 20px;">
                      <span style="flex: 1;">Inspect workspace & capture before photos</span>
                      <i class="fas fa-check-circle" style="color: var(--accent-green);"></i>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.8rem; cursor: pointer;">
                      <input type="checkbox" checked style="width: 20px; height: 20px;">
                      <span style="flex: 1;">Install equipment according to playbook</span>
                      <i class="fas fa-check-circle" style="color: var(--accent-green);"></i>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.8rem; cursor: pointer;">
                      <input type="checkbox" checked style="width: 20px; height: 20px;">
                      <span style="flex: 1;">Test system and brief customer</span>
                      <i class="fas fa-check-circle" style="color: var(--accent-green);"></i>
                    </label>
                  </div>
                </div>

                <div class="mobile-card" style="background: rgba(78, 168, 255, 0.1);">
                  <div style="font-size: 0.85rem; font-weight: 600; margin-bottom: 0.8rem;">
                    <i class="fas fa-camera"></i> Evidence Captured
                  </div>
                  <div style="display: flex; gap: 0.5rem;">
                    <div style="background: rgba(255, 255, 255, 0.1); padding: 0.5rem; border-radius: 8px; flex: 1; text-align: center;">
                      <div style="font-size: 1.5rem; font-weight: 700;">3</div>
                      <div style="font-size: 0.8rem; color: var(--text-muted);">Photos</div>
                    </div>
                    <div style="background: rgba(255, 255, 255, 0.1); padding: 0.5rem; border-radius: 8px; flex: 1; text-align: center;">
                      <div style="font-size: 1.5rem; font-weight: 700;">1</div>
                      <div style="font-size: 0.8rem; color: var(--text-muted);">Audio</div>
                    </div>
                  </div>
                </div>

                <button class="mobile-button mobile-button-secondary">
                  <i class="fas fa-camera"></i> Add More Evidence
                </button>
                <button class="mobile-button mobile-button-primary">
                  <i class="fas fa-check-double"></i> Complete Job & Request WCF
                </button>
              </div>
            </div>
          `;
        } else if (step.id === 'wcf') {
          html = `
            <div class="stakeholder-view">
              <div class="view-header">
                <h3>
                  <i class="fas fa-envelope"></i> Customer Communication
                </h3>
                <span class="role-badge role-customer">${so.customer.name.toUpperCase()}</span>
              </div>

              <div class="view-section">
                <h4 style="margin-bottom: 1rem;">ðŸ“§ Email Notification</h4>
                <div class="email-mockup">
                  <div class="email-header">
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                      <div style="background: var(--yellow); color: #1a1a1a; padding: 0.5rem 1rem; font-weight: 700; border-radius: 4px;">YellowGrid</div>
                      <div style="flex: 1;"></div>
                      <div style="font-size: 0.85rem; color: #666;">10:52 AM</div>
                    </div>
                    <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.3rem;">
                      <strong>From:</strong> no-reply@yellowgrid.pt
                    </div>
                    <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.3rem;">
                      <strong>To:</strong> ${so.customer.email}
                    </div>
                    <div style="font-size: 1.1rem; font-weight: 700; margin-top: 0.8rem;">
                      Service Complete - Please Sign Work Completion Form
                    </div>
                  </div>
                  <div class="email-body">
                    <p>Dear ${so.customer.firstName},</p>
                    <p style="margin: 1rem 0;">
                      Your service <strong>${so.services[0].name}</strong> has been completed by our technician team.
                    </p>
                    <p style="margin: 1rem 0;">
                      Please review the work and sign the Work Completion Form (WCF) by clicking the button below:
                    </p>
                    <div style="text-align: center;">
                      <a href="#" class="email-button">
                        <i class="fas fa-signature"></i> Sign WCF Online
                      </a>
                    </div>
                    <p style="margin: 1rem 0; font-size: 0.9rem; color: #666;">
                      Service Order: <strong>SRV-${so.orderId.split('-')[2]}</strong><br>
                      Completed: ${new Date().toLocaleString('en-GB')}<br>
                      Technician: Rui Lopes
                    </p>
                    <p style="margin: 1.5rem 0 0.5rem 0; font-size: 0.85rem; color: #999; border-top: 1px solid #e5e5e5; padding-top: 1rem;">
                      Questions? Contact us at support@yellowgrid.pt or +351 210 123 456
                    </p>
                  </div>
                </div>
              </div>

              <div class="view-section">
                <h4 style="margin-bottom: 1rem;">ðŸ“± SMS Notification</h4>
                <div class="sms-mockup">
                  <div style="text-align: center; color: var(--text-muted); font-size: 0.8rem; margin-bottom: 0.8rem;">
                    Today 10:52 AM
                  </div>
                  <div class="sms-bubble">
                    YellowGrid: Your service is complete! Sign the WCF here: yellowgrid.pt/wcf/SRV-${so.orderId.split('-')[2]} - Thank you!
                  </div>
                </div>
              </div>

              <div class="view-section">
                <h4 style="margin-bottom: 1rem;">ðŸŒ Web Portal (After Clicking Link)</h4>
                <div style="border: 2px solid var(--border); border-radius: 12px; padding: 1.5rem; background: rgba(255, 255, 255, 0.02);">
                  <div style="text-align: center; margin-bottom: 1.5rem;">
                    <h3 style="font-size: 1.5rem; margin-bottom: 0.5rem;">Work Completion Form</h3>
                    <p style="color: var(--text-muted);">Service Order: SRV-${so.orderId.split('-')[2]}</p>
                  </div>

                  <div style="background: rgba(73, 212, 147, 0.08); border: 2px solid rgba(73, 212, 147, 0.4); border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem; cursor: pointer; transition: all 0.2s;">
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                      <i class="fas fa-check-circle" style="font-size: 2rem; color: var(--accent-green);"></i>
                      <div style="flex: 1;">
                        <strong style="font-size: 1.1rem; color: var(--accent-green);">Sign with No Reserves</strong>
                        <p style="font-size: 0.9rem; color: var(--text-muted); margin: 0.3rem 0 0 0;">Work completed satisfactorily. Payment releases immediately.</p>
                      </div>
                    </div>
                  </div>

                  <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem; cursor: pointer;">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                      <i class="fas fa-exclamation-circle" style="font-size: 2rem; color: var(--accent-orange);"></i>
                      <div style="flex: 1;">
                        <strong style="font-size: 1.1rem;">Sign with Reserves</strong>
                        <p style="font-size: 0.9rem; color: var(--text-muted); margin: 0.3rem 0 0 0;">Issues noted. Auto-creates rework order and holds payment.</p>
                      </div>
                    </div>
                  </div>

                  <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; cursor: pointer;">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                      <i class="fas fa-times-circle" style="font-size: 2rem; color: var(--accent-red);"></i>
                      <div style="flex: 1;">
                        <strong style="font-size: 1.1rem;">Refuse to Sign</strong>
                        <p style="font-size: 0.9rem; color: var(--text-muted); margin: 0.3rem 0 0 0;">Work unacceptable. Payment blocked until resolution.</p>
                      </div>
                    </div>
                  </div>

                  <textarea style="width: 100%; padding: 1rem; border-radius: 8px; background: rgba(255, 255, 255, 0.04); border: 1px solid var(--border); color: var(--text-main); min-height: 100px; margin-bottom: 1rem;" placeholder="Optional: Add feedback about the service quality, technician professionalism, etc."></textarea>

                  <button class="btn btn-primary" style="width: 100%; padding: 1rem; font-size: 1.1rem;">
                    <i class="fas fa-signature"></i> Submit Digital Signature
                  </button>
                </div>
              </div>
            </div>
          `;
        }

        document.getElementById('stakeholderPanel').innerHTML = html;
      };

      const renderAI = () => {
        if (!currentScenario) return;
        
        const so = scenarios[currentScenario].salesOrder;
        const step = steps[currentStep];

        let html = '';

        if (step.id === 'integration') {
          html = `
            <div class="ai-insight">
              <div class="ai-insight-header">
                <i class="fas fa-robot"></i>
                <strong>Initial Assessment</strong>
              </div>
              <div class="ai-reasoning">
                Analyzing order structure and customer profile...
              </div>
              <div class="ai-confidence">
                <span>Processing</span>
                <div class="confidence-bar">
                  <div class="confidence-fill" style="width: 35%;"></div>
                </div>
                <span>35%</span>
              </div>
            </div>

            <div class="metric-card">
              <div class="metric-header">
                <span class="metric-label">Customer Signals</span>
              </div>
              <div class="metric-factors">
                <div class="factor-chip">Tier: ${so.customer.tier}</div>
                <div class="factor-chip">Claims: ${so.customer.claimHistory}</div>
                <div class="factor-chip">Customer since: ${new Date(so.customer.customerSince).getFullYear()}</div>
              </div>
            </div>

            <div class="metric-card">
              <div class="metric-header">
                <span class="metric-label">Order Complexity</span>
              </div>
              <div class="metric-factors">
                <div class="factor-chip">${so.products.length} product(s)</div>
                <div class="factor-chip">${so.services.length} service(s)</div>
                <div class="factor-chip">Total: â‚¬${so.totals.total}</div>
              </div>
            </div>
          `;
        } else if (step.id === 'ai-analysis') {
          const riskLevel = so.customer.claimHistory > 0 || so.linkedQuotation ? 'MEDIUM' : 'LOW';
          const tvPotential = so.linkedQuotation || so.sellerNotes.includes('upsell') ? 'HIGH' : 'LOW';
          html = `
            <div class="ai-insight">
              <div class="ai-insight-header">
                <i class="fas fa-brain"></i>
                <strong>Risk Assessment Complete</strong>
              </div>
              <div class="ai-reasoning">
                ${riskLevel === 'LOW' 
                  ? 'No red flags detected. Customer is new (0 claims), order structure is simple (single service), and payment is confirmed.'
                  : 'Moderate risk detected: Previous claim in customer history. However, claim was resolved and customer tier is Premium.'
                }
              </div>
              <div class="ai-confidence">
                <span>Confidence</span>
                <div class="confidence-bar">
                  <div class="confidence-fill" style="width: 87%;"></div>
                </div>
                <span>87%</span>
              </div>
            </div>

            <div class="metric-card">
              <div class="metric-header">
                <span class="metric-label">Risk Score</span>
              </div>
              <div class="metric-value risk-${riskLevel.toLowerCase()}">${riskLevel === 'LOW' ? '23' : '67'}/100</div>
              <div class="metric-factors">
                ${riskLevel === 'MEDIUM' ? 
                  '<div class="factor-chip">Previous claim</div><div class="factor-chip">Linked quotation</div>' : 
                  '<div class="factor-chip">New customer</div><div class="factor-chip">Low complexity</div>'
                }
              </div>
            </div>

            <div class="ai-insight">
              <div class="ai-insight-header">
                <i class="fas fa-lightbulb"></i>
                <strong>TV Potential: ${tvPotential}</strong>
              </div>
              <div class="ai-reasoning">
                ${tvPotential === 'HIGH' 
                  ? 'Seller notes indicate strong upsell opportunity ("' + so.sellerNotes.substring(0, 50) + '..."). Recommend bundling quotation with installation.'
                  : 'Limited upsell scope. Single product order with straightforward installation. Recommend lean offer.'
                }
              </div>
            </div>

            <div class="ai-insight">
              <div class="ai-insight-header">
                <i class="fas fa-people-arrows"></i>
                <strong>Pilote Recommendation</strong>
              </div>
              <div class="ai-reasoning">
                Suggesting <strong>PL-LIA (Lia Santos)</strong> â€¢ Greater Lisbon region â€¢ Current load: 3 orders (lightest workload)
              </div>
            </div>
          `;
        } else if (step.id === 'operator-triage') {
          html = `
            <div class="ai-insight">
              <div class="ai-insight-header">
                <i class="fas fa-check-circle"></i>
                <strong>Operator Accepted AI Suggestions</strong>
              </div>
              <div class="ai-reasoning">
                No overrides applied. Risk assessment, pilote assignment, and schedule validated by operator Maria Santos.
              </div>
            </div>

            <div class="metric-card">
              <div class="metric-header">
                <span class="metric-label">Calendar Validation</span>
              </div>
              <div class="metric-factors">
                <div class="factor-chip">âœ“ Not Sunday</div>
                <div class="factor-chip">âœ“ Weekday morning slot</div>
                <div class="factor-chip">âœ“ Within SLA</div>
              </div>
            </div>

            <div class="ai-insight">
              <div class="ai-insight-header">
                <i class="fas fa-link"></i>
                <strong>Project Linkage</strong>
              </div>
              <div class="ai-reasoning">
                Service order linked to sales project <strong>${so.salesProjectId}</strong>. No other related orders found in 30-day window.
              </div>
            </div>

            <div class="ai-insight">
              <div class="ai-insight-header">
                <i class="fas fa-arrow-right"></i>
                <strong>Next Step: Contract Generation</strong>
              </div>
              <div class="ai-reasoning">
                System will auto-generate contract bundle with 2-hour auto-send timer. Operator can expedite or override.
              </div>
            </div>
          `;
        } else if (step.id === 'contract') {
          html = `
            <div class="ai-insight">
              <div class="ai-insight-header">
                <i class="fas fa-file-contract"></i>
                <strong>Contract Template Selection</strong>
              </div>
              <div class="ai-reasoning">
                Selected <strong>"Standard Installation"</strong> template based on service type (${so.services[0].code}). Single service order, no special clauses required.
              </div>
            </div>

            <div class="metric-card">
              <div class="metric-header">
                <span class="metric-label">Bundle Configuration</span>
              </div>
              <div class="metric-factors">
                <div class="factor-chip">1 service order</div>
                <div class="factor-chip">0 linked pre-sales</div>
                <div class="factor-chip">Standard terms</div>
              </div>
            </div>

            <div class="ai-insight">
              <div class="ai-insight-header">
                <i class="fas fa-clock"></i>
                <strong>Auto-Send Timer</strong>
              </div>
              <div class="ai-reasoning">
                Contract will auto-send in <strong>2 hours</strong> unless operator intervenes. Customer will receive email + SMS notification with digital signature link.
              </div>
            </div>

            <div class="ai-insight">
              <div class="ai-insight-header">
                <i class="fas fa-lock"></i>
                <strong>Provider Matching Blocked</strong>
              </div>
              <div class="ai-reasoning">
                Crew matching will not begin until contract status is <strong>OK</strong> or <strong>NOK</strong>. This prevents crew assignment before customer commitment.
              </div>
            </div>
          `;
        } else if (step.id === 'provider-match') {
          html = `
            <div class="ai-insight">
              <div class="ai-insight-header">
                <i class="fas fa-diagram-project"></i>
                <strong>Crew Matching Algorithm</strong>
              </div>
              <div class="ai-reasoning">
                Matched 3 crews based on: location proximity (${so.customer.address.split(',')[1]}), service type expertise (kitchen installations), capacity availability, and historical SLA performance.
              </div>
            </div>

            <div class="metric-card">
              <div class="metric-header">
                <span class="metric-label">Top Match: Provider L</span>
              </div>
              <div class="metric-value" style="color: var(--accent-green); font-size: 1.5rem;">92/100</div>
              <div class="metric-factors">
                <div class="factor-chip">Proximity: 8/10</div>
                <div class="factor-chip">Expertise: 10/10</div>
                <div class="factor-chip">SLA: 9/10</div>
              </div>
            </div>

            <div class="ai-insight">
              <div class="ai-insight-header">
                <i class="fas fa-hourglass"></i>
                <strong>Response Window</strong>
              </div>
              <div class="ai-reasoning">
                Providers have <strong>4 hours</strong> to respond. Up to <strong>3 rounds of negotiation</strong> allowed. If no acceptance after 3 rounds, escalates to operator task queue.
              </div>
            </div>
          `;
        } else if (step.id === 'go-gate') {
          html = `
            <div class="ai-insight">
              <div class="ai-insight-header">
                <i class="fas fa-shield-halved"></i>
                <strong>Gate Validation</strong>
              </div>
              <div class="ai-reasoning">
                All prerequisites ${so.payment.status === 'Paid' ? '<strong style="color: var(--accent-green);">PASSED</strong>' : '<strong style="color: var(--accent-orange);">PARTIALLY MET</strong>'}. 
                ${so.payment.status === 'Paid' 
                  ? 'Payment confirmed, delivery on site, contract signed, crew assigned. Crew can check in.' 
                  : 'Payment is pending (invoice method). Delivery and contract are OK. Operator can authorize derogation if needed.'
                }
              </div>
            </div>

            <div class="metric-card">
              <div class="metric-header">
                <span class="metric-label">Gate Status</span>
              </div>
              <div class="metric-value" style="color: ${so.payment.status === 'Paid' ? 'var(--accent-green)' : 'var(--accent-orange)'}; font-size: 1.5rem;">
                ${so.payment.status === 'Paid' ? 'GO' : 'BLOCKED'}
              </div>
            </div>

            <div class="ai-insight">
              <div class="ai-insight-header">
                <i class="fas fa-mobile"></i>
                <strong>Crew Notification</strong>
              </div>
              <div class="ai-reasoning">
                ${so.payment.status === 'Paid' 
                  ? 'Mobile app unlocked for crew. Check-in will capture GPS coordinates and timestamp automatically.'
                  : 'Crew mobile app blocked until gate clears. Push notification will be sent when status changes.'
                }
              </div>
            </div>
          `;
        } else if (step.id === 'execution') {
          html = `
            <div class="ai-insight">
              <div class="ai-insight-header">
                <i class="fas fa-location-dot"></i>
                <strong>Geo-fencing Validation</strong>
              </div>
              <div class="ai-reasoning">
                Crew check-in location verified within <strong>50m</strong> of customer address. Timestamp logged: 09:03 AM (within scheduled window).
              </div>
            </div>

            <div class="metric-card">
              <div class="metric-header">
                <span class="metric-label">Execution Compliance</span>
              </div>
              <div class="metric-factors">
                <div class="factor-chip">âœ“ On-time arrival</div>
                <div class="factor-chip">âœ“ Checklist complete</div>
                <div class="factor-chip">âœ“ Evidence captured</div>
              </div>
            </div>

            <div class="ai-insight">
              <div class="ai-insight-header">
                <i class="fas fa-camera"></i>
                <strong>Evidence Validation</strong>
              </div>
              <div class="ai-reasoning">
                Crew uploaded <strong>3 photos</strong> (before/during/after) and <strong>1 audio note</strong>. All evidence synced to Control Tower in real-time.
              </div>
            </div>

            <div class="ai-insight">
              <div class="ai-insight-header">
                <i class="fas fa-arrow-right"></i>
                <strong>Next: Customer WCF</strong>
              </div>
              <div class="ai-reasoning">
                Job marked complete at 10:47 AM. WCF form sent to customer via SMS + email. Provider payment blocked until customer signs.
              </div>
            </div>
          `;
        } else if (step.id === 'wcf') {
          html = `
            <div class="ai-insight">
              <div class="ai-insight-header">
                <i class="fas fa-signature"></i>
                <strong>WCF Outcome: No Reserves</strong>
              </div>
              <div class="ai-reasoning">
                Customer <strong>${so.customer.name}</strong> signed WCF digitally with no reserves. Work accepted as complete and satisfactory.
              </div>
            </div>

            <div class="metric-card">
              <div class="metric-header">
                <span class="metric-label">Payment Release</span>
              </div>
              <div class="metric-value" style="color: var(--accent-green); font-size: 1.3rem;">â‚¬${(so.totals.services * 0.75).toFixed(2)}</div>
              <div style="margin-top: 0.5rem; color: var(--text-muted); font-size: 0.85rem;">
                Provider payout (75% of â‚¬${so.totals.services}) authorized for release on ${new Date(Date.now() + 86400000).toISOString().split('T')[0]}.
              </div>
            </div>

            <div class="ai-insight">
              <div class="ai-insight-header">
                <i class="fas fa-check-double"></i>
                <strong>Service Order Closed</strong>
              </div>
              <div class="ai-reasoning">
                Service order <strong>SRV-${so.orderId.split('-')[2]}</strong> moved to CLOSED status. No rework needed. Customer satisfaction recorded. Project ${so.salesProjectId} updated.
              </div>
            </div>

            <div class="ai-insight">
              <div class="ai-insight-header">
                <i class="fas fa-chart-line"></i>
                <strong>Performance Metrics</strong>
              </div>
              <div class="ai-reasoning">
                On-time completion â€¢ 0 derogations â€¢ 0 re-schedules â€¢ Customer satisfaction: Positive feedback recorded.
              </div>
            </div>
          `;
        }

        document.getElementById('aiPanel').innerHTML = html;
      };

      // Define journey cards for each step - Complete workflow
      const journeyCards = {
        'integration': [
          { id: 'kafka-message', type: 'data', title: 'Kafka Message', icon: 'server' },
          { id: 'enrichment', type: 'system', title: 'Enrichment', icon: 'cogs' },
          { id: 'project-creation', type: 'system', title: 'Project Creation', icon: 'folder-plus' }
        ],
        'ai-analysis': [
          { id: 'ai-reasoning', type: 'ai', title: 'AI Analysis', icon: 'robot' }
        ],
        'operator-triage': [
          { id: 'operator-cockpit', type: 'operator', title: 'Operator Triage', icon: 'headset' }
        ],
        'contract': [
          { id: 'contract-notification', type: 'customer', title: 'Contract Email/SMS', icon: 'envelope' },
          { id: 'contract-portal', type: 'customer', title: 'Contract Portal', icon: 'file-signature' }
        ],
        'provider-match': [
          { id: 'match-request', type: 'data', title: 'Match Request', icon: 'broadcast-tower' },
          { id: 'provider-funnel', type: 'system', title: 'Provider Funnel', icon: 'filter' },
          { id: 'provider-offer', type: 'provider', title: 'Provider Offer', icon: 'mobile-screen-button' }
        ],
        'go-gate': [
          { id: 'go-gate-check', type: 'system', title: 'Go-Exec Gate', icon: 'shield-check' }
        ],
        'execution': [
          { id: 'crew-execution', type: 'crew', title: 'Crew Execution', icon: 'mobile-screen-button' }
        ],
        'wcf': [
          { id: 'wcf-notification', type: 'customer', title: 'WCF Email/SMS', icon: 'envelope' },
          { id: 'wcf-portal', type: 'customer', title: 'WCF Portal', icon: 'signature' }
        ]
      };

      // Add new invoice and payment steps
      const invoicePaymentCards = [
        { id: 'invoice-portal', type: 'provider', title: 'Invoice Portal', icon: 'file-invoice', stepId: 'invoice' },
        { id: 'invoice-dataflow', type: 'data', title: 'Invoice Dataflow', icon: 'exchange-alt', stepId: 'invoice' },
        { id: 'payment-portal', type: 'provider', title: 'Payment Portal', icon: 'credit-card', stepId: 'payment' }
      ];

      // Flatten all cards with step context
      let allCards = [];
      let cardIndex = 0;
      for (const [stepIdx, step] of steps.entries()) {
        const cards = journeyCards[step.id] || [];
        for (const card of cards) {
          allCards.push({
            ...card,
            stepId: step.id,
            stepIndex: stepIdx,
            stepTitle: step.title,
            globalIndex: cardIndex++
          });
        }
      }
      
      // Add invoice and payment cards
      for (const card of invoicePaymentCards) {
        allCards.push({
          ...card,
          stepIndex: steps.length,
          stepTitle: card.stepId === 'invoice' ? 'Invoice' : 'Payment',
          globalIndex: cardIndex++
        });
      }

      let currentCardIndex = 0;

      // Card rendering functions
      const renderKafkaMessageCard = (so, card) => {
        return `
          <div style="padding: 2rem;">
            <div style="margin-bottom: 2rem;">
              <div style="display: inline-block; background: rgba(78, 168, 255, 0.15); color: var(--accent-blue); padding: 0.5rem 1rem; border-radius: 999px; font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem;">
                <i class="fas fa-server"></i> SYSTEM
              </div>
              <h2 style="font-size: 2rem; margin-bottom: 0.5rem;"><i class="fas fa-${card.icon}"></i> ${card.title}</h2>
              <p style="color: var(--text-muted); font-size: 1.1rem;">New sales order received from ${so.salesChannel}</p>
            </div>

            <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
              <h3 style="margin-bottom: 1rem;"><i class="fas fa-stream"></i> Kafka Event</h3>
              <div style="font-family: 'Courier New', monospace; font-size: 0.85rem; background: #000; padding: 1rem; border-radius: 8px; overflow-x: auto;">
                <div style="color: #49d493;">Topic: <span style="color: #fff;">sales.orders.created</span></div>
                <div style="color: #49d493;">Partition: <span style="color: #fff;">3</span></div>
                <div style="color: #49d493;">Offset: <span style="color: #fff;">982471</span></div>
                <div style="color: #49d493;">Key: <span style="color: #fff;">${so.orderId}</span></div>
              </div>
            </div>

            <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
              <h3 style="margin-bottom: 1rem;"><i class="fas fa-code"></i> Complete Message Payload</h3>
              <div style="font-family: 'Courier New', monospace; font-size: 0.75rem; background: #000; padding: 1.5rem; border-radius: 8px; max-height: 400px; overflow-y: auto; line-height: 1.7;">
                <div><span style="color: #49d493;">{</span></div>
                <div style="padding-left: 1rem;"><span style="color: #fbbf24;">"orderId"</span>: <span style="color: #fff;">"${so.orderId}"</span>,</div>
                <div style="padding-left: 1rem;"><span style="color: #fbbf24;">"salesChannel"</span>: <span style="color: #fff;">"${so.salesChannel}"</span>,</div>
                <div style="padding-left: 1rem;"><span style="color: #fbbf24;">"store"</span>: <span style="color: #fff;">"${so.store}"</span>,</div>
                <div style="padding-left: 1rem;"><span style="color: #fbbf24;">"salesProjectId"</span>: <span style="color: #fff;">"${so.salesProjectId || 'null'}"</span>,</div>
                <div style="padding-left: 1rem;"><span style="color: #fbbf24;">"leadId"</span>: <span style="color: #fff;">"${so.leadId || 'null'}"</span>,</div>
                <div style="padding-left: 1rem;"><span style="color: #fbbf24;">"quotation"</span>: <span style="color: #fff;">${so.linkedQuotation ? '"' + so.linkedQuotation + '"' : 'null'}</span>,</div>
                <div style="padding-left: 1rem;"><span style="color: #fbbf24;">"salesman"</span>: <span style="color: #fff;">"${so.salesman}"</span>,</div>
                <div style="padding-left: 1rem;"><span style="color: #fbbf24;">"salesmanEmail"</span>: <span style="color: #fff;">"${so.salesmanEmail}"</span>,</div>
                <div style="padding-left: 1rem;"><span style="color: #fbbf24;">"customer"</span>: <span style="color: #49d493;">{</span></div>
                <div style="padding-left: 2rem;"><span style="color: #fbbf24;">"customerId"</span>: <span style="color: #fff;">"${so.customer.customerId}"</span>,</div>
                <div style="padding-left: 2rem;"><span style="color: #fbbf24;">"name"</span>: <span style="color: #fff;">"${so.customer.name}"</span>,</div>
                <div style="padding-left: 2rem;"><span style="color: #fbbf24;">"email"</span>: <span style="color: #fff;">"${so.customer.email}"</span>,</div>
                <div style="padding-left: 2rem;"><span style="color: #fbbf24;">"phone"</span>: <span style="color: #fff;">"${so.customer.phone}"</span>,</div>
                <div style="padding-left: 2rem;"><span style="color: #fbbf24;">"address"</span>: <span style="color: #fff;">"${so.customer.address}"</span>,</div>
                <div style="padding-left: 2rem;"><span style="color: #fbbf24;">"city"</span>: <span style="color: #fff;">"${so.customer.city}"</span>,</div>
                <div style="padding-left: 2rem;"><span style="color: #fbbf24;">"tier"</span>: <span style="color: #fff;">"${so.customer.tier}"</span>,</div>
                <div style="padding-left: 2rem;"><span style="color: #fbbf24;">"lifetimeValue"</span>: <span style="color: #4eabff;">${so.customer.lifetimeValue}</span></div>
                <div style="padding-left: 1rem;"><span style="color: #49d493;">}</span>,</div>
                <div style="padding-left: 1rem;"><span style="color: #fbbf24;">"products"</span>: <span style="color: #c084fc;">[</span></div>
                ${so.products.map((p, idx) => `
                  <div style="padding-left: 2rem;"><span style="color: #49d493;">{</span></div>
                  <div style="padding-left: 3rem;"><span style="color: #fbbf24;">"sku"</span>: <span style="color: #fff;">"${p.sku}"</span>,</div>
                  <div style="padding-left: 3rem;"><span style="color: #fbbf24;">"name"</span>: <span style="color: #fff;">"${p.name}"</span>,</div>
                  <div style="padding-left: 3rem;"><span style="color: #fbbf24;">"quantity"</span>: <span style="color: #4eabff;">${p.quantity}</span>,</div>
                  <div style="padding-left: 3rem;"><span style="color: #fbbf24;">"unitPrice"</span>: <span style="color: #4eabff;">${p.unitPrice}</span>,</div>
                  <div style="padding-left: 3rem;"><span style="color: #fbbf24;">"deliveryDate"</span>: <span style="color: #fff;">"${p.deliveryDate}"</span>,</div>
                  <div style="padding-left: 3rem;"><span style="color: #fbbf24;">"stockStatus"</span>: <span style="color: #fff;">"${p.stockStatus}"</span></div>
                  <div style="padding-left: 2rem;"><span style="color: #49d493;">}</span>${idx < so.products.length - 1 ? ',' : ''}</div>
                `).join('')}
                <div style="padding-left: 1rem;"><span style="color: #c084fc;">]</span>,</div>
                <div style="padding-left: 1rem;"><span style="color: #fbbf24;">"services"</span>: <span style="color: #c084fc;">[</span></div>
                ${so.services.map((s, idx) => `
                  <div style="padding-left: 2rem;"><span style="color: #49d493;">{</span></div>
                  <div style="padding-left: 3rem;"><span style="color: #fbbf24;">"code"</span>: <span style="color: #fff;">"${s.code}"</span>,</div>
                  <div style="padding-left: 3rem;"><span style="color: #fbbf24;">"name"</span>: <span style="color: #fff;">"${s.name}"</span>,</div>
                  <div style="padding-left: 3rem;"><span style="color: #fbbf24;">"scheduledDate"</span>: <span style="color: #fff;">"${s.scheduledDate}"</span>,</div>
                  <div style="padding-left: 3rem;"><span style="color: #fbbf24;">"timeSlot"</span>: <span style="color: #fff;">"${s.timeSlot}"</span>,</div>
                  <div style="padding-left: 3rem;"><span style="color: #fbbf24;">"duration"</span>: <span style="color: #4eabff;">${s.duration}</span>,</div>
                  <div style="padding-left: 3rem;"><span style="color: #fbbf24;">"unitPrice"</span>: <span style="color: #4eabff;">${s.unitPrice}</span>,</div>
                  <div style="padding-left: 3rem;"><span style="color: #fbbf24;">"skillLevel"</span>: <span style="color: #fff;">"${s.skillLevel}"</span></div>
                  <div style="padding-left: 2rem;"><span style="color: #49d493;">}</span>${idx < so.services.length - 1 ? ',' : ''}</div>
                `).join('')}
                <div style="padding-left: 1rem;"><span style="color: #c084fc;">]</span>,</div>
                <div style="padding-left: 1rem;"><span style="color: #fbbf24;">"payment"</span>: <span style="color: #49d493;">{</span></div>
                <div style="padding-left: 2rem;"><span style="color: #fbbf24;">"status"</span>: <span style="color: #49d493;">"${so.payment.status}"</span>,</div>
                <div style="padding-left: 2rem;"><span style="color: #fbbf24;">"method"</span>: <span style="color: #fff;">"${so.payment.method}"</span>,</div>
                <div style="padding-left: 2rem;"><span style="color: #fbbf24;">"paidAmount"</span>: <span style="color: #4eabff;">${so.payment.paidAmount}</span>,</div>
                <div style="padding-left: 2rem;"><span style="color: #fbbf24;">"transactionId"</span>: <span style="color: #fff;">"${so.payment.transactionId}"</span></div>
                <div style="padding-left: 1rem;"><span style="color: #49d493;">}</span>,</div>
                <div style="padding-left: 1rem;"><span style="color: #fbbf24;">"totals"</span>: <span style="color: #49d493;">{</span></div>
                <div style="padding-left: 2rem;"><span style="color: #fbbf24;">"subtotal"</span>: <span style="color: #4eabff;">${so.totals.subtotal}</span>,</div>
                <div style="padding-left: 2rem;"><span style="color: #fbbf24;">"tax"</span>: <span style="color: #4eabff;">${so.totals.totalTax}</span>,</div>
                <div style="padding-left: 2rem;"><span style="color: #fbbf24;">"total"</span>: <span style="color: #4eabff;">${so.totals.total}</span></div>
                <div style="padding-left: 1rem;"><span style="color: #49d493;">}</span>,</div>
                <div style="padding-left: 1rem;"><span style="color: #fbbf24;">"sellerNotes"</span>: <span style="color: #fff;">"${so.sellerNotes ? so.sellerNotes.substring(0, 50) + '...' : 'None'}"</span></div>
                <div><span style="color: #49d493;">}</span></div>
              </div>
            </div>

            <div style="display: flex; justify-content: flex-end; gap: 1rem;">
              <button class="btn btn-primary" onclick="dashboard.nextCard()">
                System Processing <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>
        `;
      };

      const renderProjectCreationCard = (so, card) => {
        return `
          <div style="padding: 2rem;">
            <div style="margin-bottom: 2rem;">
              <div style="display: inline-block; background: rgba(78, 168, 255, 0.15); color: var(--accent-blue); padding: 0.5rem 1rem; border-radius: 999px; font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem;">
                <i class="fas fa-cogs"></i> AUTOMATED
              </div>
              <h2 style="font-size: 2rem; margin-bottom: 0.5rem;"><i class="fas fa-${card.icon}"></i> ${card.title}</h2>
              <p style="color: var(--text-muted); font-size: 1.1rem;">Linking service order to customer project</p>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
              <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem;">
                <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                  <i class="fas fa-search" style="color: var(--accent-blue);"></i>
                  Existing Projects Check
                </h3>
                <div style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 1rem;">
                  Searching for active projects for customer ${so.customer.customerId}...
                </div>
                <div style="background: rgba(73, 212, 147, 0.08); border: 1px solid rgba(73, 212, 147, 0.3); border-radius: 8px; padding: 1rem;">
                  <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <i class="fas fa-check-circle" style="color: var(--accent-green);"></i>
                    <strong>Project Found</strong>
                  </div>
                  <div style="font-size: 0.9rem; color: var(--text-muted);">
                    Project: ${so.salesProjectId}<br>
                    Status: Active<br>
                    Created: ${so.customer.customerSince}
                  </div>
                </div>
              </div>

              <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem;">
                <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                  <i class="fas fa-link" style="color: var(--yellow);"></i>
                  Service Order Linking
                </h3>
                <div style="background: rgba(255, 203, 50, 0.08); border: 1px solid rgba(255, 203, 50, 0.3); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                  <div style="font-weight: 600; margin-bottom: 0.5rem;">Action Taken:</div>
                  <div style="font-size: 0.9rem; color: var(--text-muted);">
                    âœ“ Service Order <strong>${so.orderId}</strong><br>
                    âœ“ Linked to Project <strong>${so.salesProjectId}</strong><br>
                    âœ“ Customer context preserved<br>
                    âœ“ Historical data accessible
                  </div>
                </div>
                <div style="font-size: 0.85rem; color: var(--text-muted);">
                  <i class="fas fa-info-circle"></i> Enables: cross-order analytics, bundled contracts, unified customer view
                </div>
              </div>
            </div>

            <div style="background: rgba(78, 168, 255, 0.08); border: 1px solid rgba(78, 168, 255, 0.3); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
              <h4 style="margin-bottom: 1rem;"><i class="fas fa-folder-open"></i> Project Context</h4>
              <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;">
                <div style="text-align: center;">
                  <div style="font-size: 1.8rem; font-weight: 700; color: var(--accent-blue);">3</div>
                  <div style="font-size: 0.85rem; color: var(--text-muted);">Total Orders</div>
                </div>
                <div style="text-align: center;">
                  <div style="font-size: 1.8rem; font-weight: 700; color: var(--accent-green);">â‚¬${so.customer.lifetimeValue}</div>
                  <div style="font-size: 0.85rem; color: var(--text-muted);">Project Value</div>
                </div>
                <div style="text-align: center;">
                  <div style="font-size: 1.8rem; font-weight: 700; color: var(--yellow);">${so.customer.tier}</div>
                  <div style="font-size: 0.85rem; color: var(--text-muted);">Customer Tier</div>
                </div>
                <div style="text-align: center;">
                  <div style="font-size: 1.8rem; font-weight: 700; color: var(--accent-green);">0</div>
                  <div style="font-size: 0.85rem; color: var(--text-muted);">Claims</div>
                </div>
              </div>
            </div>

            <div style="display: flex; justify-content: flex-end; gap: 1rem;">
              <button class="btn btn-secondary" onclick="dashboard.previousCard()">
                <i class="fas fa-arrow-left"></i> Back
              </button>
              <button class="btn btn-primary" onclick="dashboard.nextCard()">
                Send to AI Analysis <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>
        `;
      };

      const renderEnrichmentCard = (so, card) => {
        return `
          <div style="padding: 2rem;">
            <div style="margin-bottom: 2rem;">
              <div style="display: inline-block; background: rgba(192, 132, 252, 0.15); color: var(--accent-purple); padding: 0.5rem 1rem; border-radius: 999px; font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem;">
                <i class="fas fa-cogs"></i> AUTOMATED
              </div>
              <h2 style="font-size: 2rem; margin-bottom: 0.5rem;"><i class="fas fa-${card.icon}"></i> ${card.title}</h2>
              <p style="color: var(--text-muted); font-size: 1.1rem;">Enriching order with business context</p>
            </div>

            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; margin-bottom: 2rem;">
              <div style="background: rgba(73, 212, 147, 0.08); border: 1px solid rgba(73, 212, 147, 0.3); border-radius: 12px; padding: 1.5rem;">
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                  <i class="fas fa-check-circle" style="color: var(--accent-green); font-size: 1.5rem;"></i>
                  <strong style="font-size: 1.1rem;">Customer Profile Loaded</strong>
                </div>
                <div style="font-size: 0.9rem; color: var(--text-muted);">
                  Tier: ${so.customer.tier} â€¢ LTV: â‚¬${so.customer.lifetimeValue} â€¢ Claims: ${so.customer.claimHistory}
                </div>
              </div>

              <div style="background: rgba(73, 212, 147, 0.08); border: 1px solid rgba(73, 212, 147, 0.3); border-radius: 12px; padding: 1.5rem;">
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                  <i class="fas fa-check-circle" style="color: var(--accent-green); font-size: 1.5rem;"></i>
                  <strong style="font-size: 1.1rem;">Product Data Enriched</strong>
                </div>
                <div style="font-size: 0.9rem; color: var(--text-muted);">
                  Supplier: ${so.products[0].supplier} â€¢ Stock: ${so.products[0].stockStatus}
                </div>
              </div>

              <div style="background: rgba(73, 212, 147, 0.08); border: 1px solid rgba(73, 212, 147, 0.3); border-radius: 12px; padding: 1.5rem;">
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                  <i class="fas fa-check-circle" style="color: var(--accent-green); font-size: 1.5rem;"></i>
                  <strong style="font-size: 1.1rem;">Service Requirements Set</strong>
                </div>
                <div style="font-size: 0.9rem; color: var(--text-muted);">
                  Duration: ${so.services[0].duration}min â€¢ Skill: ${so.services[0].skillLevel}
                </div>
              </div>

              <div style="background: rgba(73, 212, 147, 0.08); border: 1px solid rgba(73, 212, 147, 0.3); border-radius: 12px; padding: 1.5rem;">
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                  <i class="fas fa-check-circle" style="color: var(--accent-green); font-size: 1.5rem;"></i>
                  <strong style="font-size: 1.1rem;">Project Linked</strong>
                </div>
                <div style="font-size: 0.9rem; color: var(--text-muted);">
                  Sales Project: ${so.salesProjectId}
                </div>
              </div>
            </div>

            <div style="display: flex; justify-content: flex-end; gap: 1rem;">
              <button class="btn btn-secondary" onclick="dashboard.previousCard()">
                <i class="fas fa-arrow-left"></i> Back
              </button>
              <button class="btn btn-primary" onclick="dashboard.nextCard()">
                Send to AI Analysis <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>
        `;
      };

      const renderAIReasoningCard = (so, card) => {
        const riskScore = so.customer.claimHistory > 0 ? 67 : 23;
        const riskLevel = riskScore > 50 ? 'MEDIUM' : 'LOW';
        return `
          <div style="padding: 2rem;">
            <div style="margin-bottom: 2rem;">
              <div style="display: inline-block; background: rgba(192, 132, 252, 0.15); color: var(--accent-purple); padding: 0.5rem 1rem; border-radius: 999px; font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem;">
                <i class="fas fa-robot"></i> AI ENGINE
              </div>
              <h2 style="font-size: 2rem; margin-bottom: 0.5rem;"><i class="fas fa-${card.icon}"></i> ${card.title}</h2>
              <p style="color: var(--text-muted); font-size: 1.1rem;">Analyzing order risk, scheduling, and resource matching</p>
            </div>

            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin-bottom: 2rem;">
              <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; text-align: center;">
                <div style="font-size: 3rem; color: var(--accent-${riskLevel === 'LOW' ? 'green' : 'orange'}); margin-bottom: 0.5rem;">${riskScore}</div>
                <div style="font-weight: 600; margin-bottom: 0.3rem;">Risk Score</div>
                <div style="font-size: 0.85rem; color: var(--text-muted);">${riskLevel} RISK</div>
              </div>

              <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; text-align: center;">
                <div style="font-size: 3rem; color: var(--accent-blue); margin-bottom: 0.5rem;">92</div>
                <div style="font-weight: 600; margin-bottom: 0.3rem;">Match Score</div>
                <div style="font-size: 0.85rem; color: var(--text-muted);">EXCELLENT</div>
              </div>

              <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; text-align: center;">
                <div style="font-size: 3rem; color: var(--yellow); margin-bottom: 0.5rem;">âœ“</div>
                <div style="font-weight: 600; margin-bottom: 0.3rem;">Schedule Valid</div>
                <div style="font-size: 0.85rem; color: var(--text-muted);">COMPLIANT</div>
              </div>
            </div>

            <div style="background: rgba(192, 132, 252, 0.08); border: 1px solid rgba(192, 132, 252, 0.3); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
              <h3 style="margin-bottom: 1rem;"><i class="fas fa-brain"></i> AI Recommendations</h3>
              <div style="display: flex; flex-direction: column; gap: 0.8rem;">
                <div style="display: flex; align-items: center; gap: 0.8rem;">
                  <i class="fas fa-check-circle" style="color: var(--accent-green);"></i>
                  <span><strong>Suggested Pilote:</strong> PL-LIA (Lia Santos) â€¢ Current load: 3 orders</span>
                </div>
                <div style="display: flex; align-items: center; gap: 0.8rem;">
                  <i class="fas fa-check-circle" style="color: var(--accent-green);"></i>
                  <span><strong>Schedule:</strong> ${so.services[0].scheduledDate} ${so.services[0].timeSlot} (Compliant - weekday AM)</span>
                </div>
                <div style="display: flex; align-items: center; gap: 0.8rem;">
                  <i class="fas fa-check-circle" style="color: var(--accent-green);"></i>
                  <span><strong>Provider:</strong> Provider L (Rui Lopes crew) â€¢ 2 technicians available</span>
                </div>
              </div>
            </div>

            <div style="display: flex; justify-content: flex-end; gap: 1rem;">
              <button class="btn btn-secondary" onclick="dashboard.previousCard()">
                <i class="fas fa-arrow-left"></i> Back
              </button>
              <button class="btn btn-primary" onclick="dashboard.nextCard()">
                Send to Operator <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>
        `;
      };

      const renderOperatorCockpitCard = (so, card) => {
        const riskLevel = so.customer.claimHistory > 0 ? 'MEDIUM' : 'LOW';
        return `
          <div style="padding: 2rem;">
            <div style="margin-bottom: 2rem;">
              <div style="display: inline-block; background: rgba(255, 203, 50, 0.15); color: var(--yellow); padding: 0.5rem 1rem; border-radius: 999px; font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem;">
                <i class="fas fa-headset"></i> OPERATOR
              </div>
              <h2 style="font-size: 2rem; margin-bottom: 0.5rem;"><i class="fas fa-${card.icon}"></i> Control Tower Cockpit</h2>
              <p style="color: var(--text-muted); font-size: 1.1rem;">Service Operator: Maria Santos</p>
            </div>

            ${renderOperatorCockpitContent(so, riskLevel)}

            <div style="display: flex; justify-content: space-between; gap: 1rem; margin-top: 2rem;">
              <button class="btn btn-secondary" onclick="dashboard.previousCard()">
                <i class="fas fa-arrow-left"></i> Back
              </button>
              <div style="display: flex; gap: 1rem;">
                <button class="btn btn-secondary">Override Risk</button>
                <button class="btn btn-primary" onclick="dashboard.nextCard()">
                  âœ“ Confirm & Send Contract <i class="fas fa-arrow-right"></i>
                </button>
              </div>
            </div>
          </div>
        `;
      };

      const renderOperatorCockpitContent = (so, riskLevel) => {
        return `
          <div class="cockpit-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin-bottom: 2rem;">
            <div class="cockpit-card" style="background: linear-gradient(135deg, rgba(78, 168, 255, 0.1), rgba(78, 168, 255, 0.05)); border: 1px solid rgba(78, 168, 255, 0.3); border-radius: 12px; padding: 1.5rem;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <span style="font-size: 0.85rem; font-weight: 600; text-transform: uppercase; color: var(--accent-blue);">Risk Score</span>
                <i class="fas fa-${riskLevel === 'LOW' ? 'shield-check' : 'shield-exclamation'}" style="color: var(--accent-${riskLevel === 'LOW' ? 'green' : 'orange'}); font-size: 1.3rem;"></i>
              </div>
              <div style="font-size: 2.5rem; font-weight: 700; color: var(--accent-${riskLevel === 'LOW' ? 'green' : 'orange'}); margin-bottom: 0.5rem;">${riskLevel === 'LOW' ? '23' : '67'}</div>
              <div style="font-size: 0.85rem; color: var(--text-muted);">
                ${riskLevel === 'LOW' ? 'No red flags' : 'Previous claim + quotation'}
              </div>
            </div>
            
            <div class="cockpit-card" style="background: linear-gradient(135deg, rgba(255, 203, 50, 0.1), rgba(255, 203, 50, 0.05)); border: 1px solid rgba(255, 203, 50, 0.3); border-radius: 12px; padding: 1.5rem;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <span style="font-size: 0.85rem; font-weight: 600; text-transform: uppercase; color: var(--yellow);">Customer Tier</span>
                <i class="fas fa-crown" style="color: var(--yellow); font-size: 1.3rem;"></i>
              </div>
              <div style="font-size: 2.5rem; font-weight: 700; margin-bottom: 0.5rem;">${so.customer.tier}</div>
              <div style="font-size: 0.85rem; color: var(--text-muted);">
                LTV: â‚¬${so.customer.lifetimeValue}
              </div>
            </div>
            
            <div class="cockpit-card" style="background: linear-gradient(135deg, rgba(73, 212, 147, 0.1), rgba(73, 212, 147, 0.05)); border: 1px solid rgba(73, 212, 147, 0.3); border-radius: 12px; padding: 1.5rem;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <span style="font-size: 0.85rem; font-weight: 600; text-transform: uppercase; color: var(--accent-green);">Payment</span>
                <i class="fas fa-${so.payment.status === 'Paid' ? 'circle-check' : 'clock'}" style="color: var(--accent-${so.payment.status === 'Paid' ? 'green' : 'orange'}); font-size: 1.3rem;"></i>
              </div>
              <div style="font-size: 2rem; font-weight: 700; color: var(--accent-${so.payment.status === 'Paid' ? 'green' : 'orange'}); margin-bottom: 0.5rem;">${so.payment.status.toUpperCase()}</div>
              <div style="font-size: 0.85rem; color: var(--text-muted);">
                ${so.payment.status === 'Paid' ? `â‚¬${so.payment.paidAmount} via ${so.payment.method}` : `Due: ${so.payment.dueDate || 'N/A'}`}
              </div>
            </div>
          </div>

          <div style="background: rgba(192, 132, 252, 0.08); border: 1px solid rgba(192, 132, 252, 0.3); border-radius: 8px; padding: 1rem;">
            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
              <i class="fas fa-robot" style="color: var(--accent-purple);"></i>
              <strong style="color: var(--accent-purple);">AI Recommendations Accepted</strong>
            </div>
            <div style="font-size: 0.9rem;">âœ“ Pilote: PL-LIA (Lia Santos) â€¢ Load: 3 orders<br>âœ“ Schedule: Compliant (not Sunday, weekday AM)<br>âœ“ Project: Linked to ${so.salesProjectId}</div>
          </div>
        `;
      };

      const renderContractNotificationCard = (so, card) => {
        return `
          <div style="padding: 2rem;">
            <div style="margin-bottom: 2rem;">
              <div style="display: inline-block; background: rgba(78, 168, 255, 0.15); color: var(--accent-blue); padding: 0.5rem 1rem; border-radius: 999px; font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem;">
                <i class="fas fa-user"></i> CUSTOMER
              </div>
              <h2 style="font-size: 2rem; margin-bottom: 0.5rem;"><i class="fas fa-${card.icon}"></i> ${card.title}</h2>
              <p style="color: var(--text-muted); font-size: 1.1rem;">Email & SMS sent to ${so.customer.name}</p>
            </div>

            <div class="email-mockup" style="background: #fff; color: #333; border-radius: 12px; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.3); max-width: 600px; margin: 0 auto 2rem;">
              <div class="email-header" style="padding: 1.5rem; border-bottom: 1px solid #e5e5e5;">
                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                  <div style="background: var(--yellow); color: #1a1a1a; padding: 0.5rem 1rem; font-weight: 700; border-radius: 4px;">YellowGrid</div>
                  <div style="flex: 1;"></div>
                  <div style="font-size: 0.85rem; color: #666;">Just now</div>
                </div>
                <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.3rem;">
                  <strong>From:</strong> contracts@yellowgrid.pt
                </div>
                <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.3rem;">
                  <strong>To:</strong> ${so.customer.email}
                </div>
                <div style="font-size: 1.1rem; font-weight: 700; margin-top: 0.8rem;">
                  Service Contract Ready for Signature
                </div>
              </div>
              <div class="email-body" style="padding: 1.5rem;">
                <p>Dear ${so.customer.firstName},</p>
                <p style="margin: 1rem 0;">Your service contract is ready. Please sign within 48 hours to confirm your ${so.services[0].scheduledDate} appointment.</p>
                <div style="text-align: center; margin: 1.5rem 0;">
                  <div style="background: var(--yellow); color: #1a1a1a; padding: 1rem 2rem; border-radius: 8px; display: inline-block; font-weight: 700; cursor: pointer;">
                    <i class="fas fa-file-signature"></i> Review & Sign Contract
                  </div>
                </div>
              </div>
            </div>

            <div style="display: flex; justify-content: space-between; gap: 1rem;">
              <button class="btn btn-secondary" onclick="dashboard.previousCard()">
                <i class="fas fa-arrow-left"></i> Back
              </button>
              <button class="btn btn-primary" onclick="dashboard.nextCard()">
                Customer Opens Email <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>
        `;
      };

      const renderContractPortalCard = (so, card) => {
        return `
          <div style="padding: 2rem;">
            <div style="margin-bottom: 2rem;">
              <div style="display: inline-block; background: rgba(78, 168, 255, 0.15); color: var(--accent-blue); padding: 0.5rem 1rem; border-radius: 999px; font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem;">
                <i class="fas fa-user"></i> CUSTOMER
              </div>
              <h2 style="font-size: 2rem; margin-bottom: 0.5rem;"><i class="fas fa-${card.icon}"></i> Contract Signature Portal</h2>
              <p style="color: var(--text-muted); font-size: 1.1rem;">${so.customer.name} reviewing contract</p>
            </div>

            <div style="background: rgba(255, 255, 255, 0.03); border: 2px solid var(--border); border-radius: 12px; padding: 2rem; max-width: 800px; margin: 0 auto 2rem;">
              <div style="text-align: center; margin-bottom: 2rem;">
                <div style="display: inline-block; background: var(--yellow); color: #1a1a1a; padding: 0.5rem 1.5rem; font-weight: 700; border-radius: 4px; margin-bottom: 1rem;">YellowGrid</div>
                <h3 style="font-size: 1.8rem; margin-bottom: 0.5rem;">Service Contract</h3>
                <p style="color: var(--text-muted);">Total: <strong style="color: var(--yellow); font-size: 1.5rem;">â‚¬${so.totals.total}</strong></p>
              </div>

              <div style="background: rgba(73, 212, 147, 0.08); border: 2px solid rgba(73, 212, 147, 0.4); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                  <i class="fas fa-check-circle" style="font-size: 2.5rem; color: var(--accent-green);"></i>
                  <div style="flex: 1;">
                    <strong style="font-size: 1.2rem; color: var(--accent-green);">I Accept Terms & Conditions</strong>
                    <p style="font-size: 0.9rem; color: var(--text-muted); margin: 0.3rem 0 0 0;">Authorize service execution on ${so.services[0].scheduledDate}</p>
                  </div>
                </div>
              </div>

              <div style="border: 2px dashed var(--border); border-radius: 8px; padding: 1.5rem; text-align: center; margin-bottom: 1.5rem;">
                <i class="fas fa-signature" style="font-size: 2rem; color: var(--yellow); margin-bottom: 0.5rem;"></i>
                <div style="font-size: 1.2rem; font-style: italic; margin-top: 1rem;">${so.customer.name}</div>
                <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem;">Signed: ${new Date().toLocaleDateString('en-GB')}</div>
              </div>
            </div>

            <div style="display: flex; justify-content: space-between; gap: 1rem;">
              <button class="btn btn-secondary" onclick="dashboard.previousCard()">
                <i class="fas fa-arrow-left"></i> Back
              </button>
              <button class="btn btn-primary" onclick="dashboard.nextCard()">
                <i class="fas fa-check-circle"></i> Sign Contract <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>
        `;
      };

      const renderMatchRequestCard = (so, card) => {
        return `
          <div style="padding: 2rem;">
            <div style="margin-bottom: 2rem;">
              <div style="display: inline-block; background: rgba(78, 168, 255, 0.15); color: var(--accent-blue); padding: 0.5rem 1rem; border-radius: 999px; font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem;">
                <i class="fas fa-broadcast-tower"></i> SYSTEM
              </div>
              <h2 style="font-size: 2rem; margin-bottom: 0.5rem;"><i class="fas fa-${card.icon}"></i> ${card.title}</h2>
              <p style="color: var(--text-muted); font-size: 1.1rem;">Broadcasting service request to provider network</p>
            </div>

            <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border); border-radius: 12px; padding: 2rem; margin-bottom: 2rem;">
              <h3 style="margin-bottom: 1.5rem;"><i class="fas fa-satellite-dish"></i> Complete Broadcast Message</h3>
              <div style="font-family: 'Courier New', monospace; font-size: 0.8rem; background: #000; padding: 1.5rem; border-radius: 8px; line-height: 1.7; max-height: 350px; overflow-y: auto;">
                <div style="color: #49d493;">Event: <span style="color: #fff;">provider.match.request</span></div>
                <div style="color: #49d493;">OrderId: <span style="color: #fff;">${so.orderId}</span></div>
                <div style="color: #49d493;">SalesProjectId: <span style="color: #fff;">"${so.salesProjectId || 'null'}"</span></div>
                <div style="color: #49d493;">Quotation: <span style="color: #fff;">${so.linkedQuotation ? '"' + so.linkedQuotation + '"' : 'null'}</span></div>
                <div style="color: #49d493;">Salesman: <span style="color: #fff;">"${so.salesman}"</span></div>
                <div style="color: #c084fc; margin-top: 0.5rem; font-weight: 700;">// Customer Info</div>
                <div style="color: #49d493;">CustomerId: <span style="color: #fff;">"${so.customer.customerId}"</span></div>
                <div style="color: #49d493;">CustomerName: <span style="color: #fff;">"${so.customer.name}"</span></div>
                <div style="color: #49d493;">CustomerEmail: <span style="color: #fff;">"${so.customer.email}"</span></div>
                <div style="color: #49d493;">CustomerPhone: <span style="color: #fff;">"${so.customer.phone}"</span></div>
                <div style="color: #49d493;">Address: <span style="color: #fff;">"${so.customer.address}"</span></div>
                <div style="color: #49d493;">City: <span style="color: #fff;">"${so.customer.city}"</span></div>
                <div style="color: #49d493;">CustomerTier: <span style="color: #fbbf24;">"${so.customer.tier}"</span></div>
                <div style="color: #49d493;">LifetimeValue: <span style="color: #4eabff;">${so.customer.lifetimeValue}</span></div>
                <div style="color: #c084fc; margin-top: 0.5rem; font-weight: 700;">// Products to Install</div>
                ${so.products.map(p => `<div style="color: #49d493;">- <span style="color: #fff;">"${p.name}" (${p.sku}) x${p.quantity}</span></div>`).join('')}
                <div style="color: #c084fc; margin-top: 0.5rem; font-weight: 700;">// Service Details</div>
                <div style="color: #49d493;">ServiceCode: <span style="color: #fff;">"${so.services[0].code}"</span></div>
                <div style="color: #49d493;">ServiceName: <span style="color: #fff;">"${so.services[0].name}"</span></div>
                <div style="color: #49d493;">ScheduledDate: <span style="color: #fff;">"${so.services[0].scheduledDate}"</span></div>
                <div style="color: #49d493;">TimeSlot: <span style="color: #fff;">"${so.services[0].timeSlot}"</span></div>
                <div style="color: #49d493;">Duration: <span style="color: #4eabff;">${so.services[0].duration}</span> min</div>
                <div style="color: #49d493;">SkillRequired: <span style="color: #fff;">"${so.services[0].skillLevel}"</span></div>
                <div style="color: #49d493;">TechniciansRequired: <span style="color: #4eabff;">${so.services[0].techniciansRequired || 1}</span></div>
                <div style="color: #49d493;">Equipment: <span style="color: #c084fc;">[${so.services[0].equipmentNeeded ? so.services[0].equipmentNeeded.join(', ') : 'Standard tools'}]</span></div>
                <div style="color: #c084fc; margin-top: 0.5rem; font-weight: 700;">// Payment & Pricing</div>
                <div style="color: #49d493;">PaymentStatus: <span style="color: #49d493;">"${so.payment.status}"</span></div>
                <div style="color: #49d493;">PaymentMethod: <span style="color: #fff;">"${so.payment.method}"</span></div>
                <div style="color: #49d493;">ServicePrice: <span style="color: #4eabff;">â‚¬${so.services[0].unitPrice}</span></div>
                <div style="color: #49d493;">TotalOrderValue: <span style="color: #4eabff;">â‚¬${so.totals.total}</span></div>
                <div style="color: #c084fc; margin-top: 0.5rem; font-weight: 700;">// Special Instructions</div>
                <div style="color: #49d493;">SellerNotes: <span style="color: #fff;">"${so.sellerNotes ? so.sellerNotes.substring(0, 80) + '...' : 'None'}"</span></div>
                <div style="color: #49d493;">SpecialInstructions: <span style="color: #fff;">"${so.specialInstructions || 'None'}"</span></div>
              </div>
            </div>

            <div style="background: rgba(78, 168, 255, 0.08); border: 1px solid rgba(78, 168, 255, 0.3); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
              <h4 style="margin-bottom: 1rem;"><i class="fas fa-network-wired"></i> Network Response</h4>
              <div style="display: flex; justify-content: space-around;">
                <div style="text-align: center;">
                  <div style="font-size: 2.5rem; font-weight: 700; color: var(--accent-blue);">12</div>
                  <div style="font-size: 0.9rem; color: var(--text-muted);">Providers Reached</div>
                </div>
                <div style="text-align: center;">
                  <div style="font-size: 2.5rem; font-weight: 700; color: var(--accent-green);">8</div>
                  <div style="font-size: 0.9rem; color: var(--text-muted);">Eligible</div>
                </div>
                <div style="text-align: center;">
                  <div style="font-size: 2.5rem; font-weight: 700; color: var(--yellow);">3</div>
                  <div style="font-size: 0.9rem; color: var(--text-muted);">Available</div>
                </div>
              </div>
            </div>

            <div style="display: flex; justify-content: flex-end; gap: 1rem;">
              <button class="btn btn-secondary" onclick="dashboard.previousCard()">
                <i class="fas fa-arrow-left"></i> Back
              </button>
              <button class="btn btn-primary" onclick="dashboard.nextCard()">
                Run Matching Algorithm <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>
        `;
      };

      const renderProviderFunnelCard = (so, card) => {
        return `
          <div style="padding: 2rem;">
            <div style="margin-bottom: 2rem;">
              <div style="display: inline-block; background: rgba(192, 132, 252, 0.15); color: var(--accent-purple); padding: 0.5rem 1rem; border-radius: 999px; font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem;">
                <i class="fas fa-robot"></i> AI MATCHING
              </div>
              <h2 style="font-size: 2rem; margin-bottom: 0.5rem;"><i class="fas fa-${card.icon}"></i> Provider Selection Funnel</h2>
              <p style="color: var(--text-muted); font-size: 1.1rem;">Scoring and ranking providers</p>
            </div>

            <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border); border-radius: 12px; padding: 2rem; margin-bottom: 2rem;">
              <h3 style="margin-bottom: 1.5rem;"><i class="fas fa-trophy"></i> Top Candidates</h3>
              
              <div style="background: linear-gradient(135deg, rgba(255, 203, 50, 0.15), rgba(255, 203, 50, 0.05)); border: 2px solid var(--yellow); border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <div style="font-size: 1.3rem; font-weight: 700; margin-bottom: 0.3rem;">ðŸ¥‡ Provider L - Rui Lopes</div>
                    <div style="font-size: 0.9rem; color: var(--text-muted);">Lisboa Region â€¢ 2 technicians â€¢ Level 3</div>
                  </div>
                  <div style="text-align: right;">
                    <div style="font-size: 2.5rem; font-weight: 700; color: var(--yellow);">92</div>
                    <div style="font-size: 0.85rem; color: var(--text-muted);">Match Score</div>
                  </div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">
                  <div>
                    <div style="font-size: 0.75rem; color: var(--text-muted);">DISTANCE</div>
                    <div style="font-weight: 600;">8.2 km</div>
                  </div>
                  <div>
                    <div style="font-size: 0.75rem; color: var(--text-muted);">AVAILABILITY</div>
                    <div style="font-weight: 600; color: var(--accent-green);">Available</div>
                  </div>
                  <div>
                    <div style="font-size: 0.75rem; color: var(--text-muted);">SLA</div>
                    <div style="font-weight: 600;">T+48h</div>
                  </div>
                  <div>
                    <div style="font-size: 0.75rem; color: var(--text-muted);">RATING</div>
                    <div style="font-weight: 600;">4.8 â­</div>
                  </div>
                </div>
              </div>

              <div style="background: rgba(255, 255, 255, 0.02); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <div style="font-size: 1.1rem; font-weight: 700; margin-bottom: 0.3rem;">ðŸ¥ˆ Provider M - JoÃ£o Silva</div>
                    <div style="font-size: 0.9rem; color: var(--text-muted);">Lisboa Region â€¢ 3 technicians â€¢ Level 3</div>
                  </div>
                  <div style="text-align: right;">
                    <div style="font-size: 2rem; font-weight: 700; color: var(--text-muted);">85</div>
                    <div style="font-size: 0.85rem; color: var(--text-muted);">Score</div>
                  </div>
                </div>
              </div>

              <div style="background: rgba(255, 255, 255, 0.02); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <div style="font-size: 1.1rem; font-weight: 700; margin-bottom: 0.3rem;">ðŸ¥‰ Provider N - Pedro Costa</div>
                    <div style="font-size: 0.9rem; color: var(--text-muted);">Lisboa Region â€¢ 1 technician â€¢ Level 2</div>
                  </div>
                  <div style="text-align: right;">
                    <div style="font-size: 2rem; font-weight: 700; color: var(--text-muted);">78</div>
                    <div style="font-size: 0.85rem; color: var(--text-muted);">Score</div>
                  </div>
                </div>
              </div>
            </div>

            <div style="background: rgba(192, 132, 252, 0.08); border: 1px solid rgba(192, 132, 252, 0.3); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
              <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                <i class="fas fa-robot" style="color: var(--accent-purple);"></i>
                <strong style="color: var(--accent-purple);">AI Decision</strong>
              </div>
              <div style="font-size: 0.95rem;">Sending offer to Provider L (score 92/100). Higher availability, closer location, better historical performance.</div>
            </div>

            <div style="display: flex; justify-content: flex-end; gap: 1rem;">
              <button class="btn btn-secondary" onclick="dashboard.previousCard()">
                <i class="fas fa-arrow-left"></i> Back
              </button>
              <button class="btn btn-primary" onclick="dashboard.nextCard()">
                Send Offer to Provider L <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>
        `;
      };

      const renderProviderOfferCard = (so, card) => {
        return `
          <div style="padding: 2rem;">
            <div style="margin-bottom: 2rem;">
              <div style="display: inline-block; background: rgba(251, 191, 36, 0.15); color: var(--accent-orange); padding: 0.5rem 1rem; border-radius: 999px; font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem;">
                <i class="fas fa-handshake"></i> PROVIDER
              </div>
              <h2 style="font-size: 2rem; margin-bottom: 0.5rem;"><i class="fas fa-${card.icon}"></i> Provider Mobile App</h2>
              <p style="color: var(--text-muted); font-size: 1.1rem;">Provider L - Rui Lopes</p>
            </div>

            <div class="mobile-screen" style="max-width: 400px; margin: 0 auto 2rem; background: #000; border-radius: 32px; padding: 1.5rem 1rem; box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
              <div style="text-align: center; margin-bottom: 1.5rem;">
                <div style="font-size: 1.3rem; font-weight: 700;">YellowGrid Pro</div>
              </div>

              <div class="mobile-card" style="background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #1a1405; padding: 1.5rem; border-radius: 16px; margin-bottom: 1rem;">
                <div style="font-size: 0.85rem; font-weight: 600; text-transform: uppercase; margin-bottom: 0.5rem;">New Assignment</div>
                <div style="font-size: 1.8rem; font-weight: 700; margin-bottom: 0.3rem;">Match: 92/100</div>
                <div style="font-size: 0.9rem;">
                  <i class="fas fa-check-circle"></i> Perfect fit for your crew
                </div>
              </div>

              <div style="background: rgba(255,255,255,0.1); padding: 1.5rem; border-radius: 16px; margin-bottom: 1rem;">
                <div style="font-size: 1.1rem; font-weight: 700; margin-bottom: 1rem;">${so.services[0].name}</div>
                <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                  <div style="flex: 1;">
                    <div style="font-size: 0.75rem; color: #999; margin-bottom: 0.3rem;">DATE</div>
                    <div style="font-weight: 600;">${so.services[0].scheduledDate}</div>
                  </div>
                  <div style="flex: 1;">
                    <div style="font-size: 0.75rem; color: #999; margin-bottom: 0.3rem;">TIME</div>
                    <div style="font-weight: 600;">${so.services[0].timeSlot}</div>
                  </div>
                </div>
                <div style="background: rgba(73, 212, 147, 0.2); padding: 0.8rem; border-radius: 8px; font-size: 0.9rem; margin-bottom: 1rem;">
                  <strong style="color: #49d493;"><i class="fas fa-check"></i> Your Crew Available</strong><br>
                  <span style="color: #ccc;">Rui Lopes â€¢ 2 installers â€¢ SLA: T+48h</span>
                </div>

                <div style="background: rgba(255, 203, 50, 0.15); border: 1px solid rgba(255, 203, 50, 0.4); padding: 0.8rem; border-radius: 8px; font-size: 0.9rem; margin-bottom: 1rem;">
                  <strong style="color: var(--yellow);"><i class="fas fa-clock"></i> Expires in 1h 47min</strong><br>
                  <span style="color: #999;">Respond before offer expires</span>
                </div>

                <button style="width: 100%; padding: 1rem; background: linear-gradient(135deg, #49d493, #31a576); color: #000; font-weight: 700; border: none; border-radius: 12px; cursor: pointer; margin-bottom: 0.75rem;">
                  <i class="fas fa-check"></i> Accept Offer
                </button>
                <button style="width: 100%; padding: 1rem; background: rgba(78, 168, 255, 0.2); color: var(--accent-blue); font-weight: 600; border: 1px solid var(--accent-blue); border-radius: 12px; cursor: pointer; margin-bottom: 0.75rem;">
                  <i class="fas fa-calendar-alt"></i> Accept & Propose Different Date
                </button>
                <button style="width: 100%; padding: 0.8rem; background: rgba(255, 255, 255, 0.05); color: #999; font-weight: 600; border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; cursor: pointer;">
                  <i class="fas fa-times"></i> Refuse Offer
                </button>
              </div>

              <div style="background: rgba(78, 168, 255, 0.1); border: 1px solid rgba(78, 168, 255, 0.3); border-radius: 12px; padding: 0.75rem; text-align: center;">
                <div style="font-size: 0.8rem;">
                  <i class="fas fa-info-circle" style="color: var(--accent-blue);"></i>
                  <span style="color: #999;"> Auto-accepted for ES/IT markets</span>
                </div>
              </div>
            </div>

            <div style="display: flex; justify-content: space-between; gap: 1rem;">
              <button class="btn btn-secondary" onclick="dashboard.previousCard()">
                <i class="fas fa-arrow-left"></i> Back
              </button>
              <button class="btn btn-primary" onclick="dashboard.nextCard()">
                Provider Accepted <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>
        `;
      };

      const renderGoGateCard = (so, card) => {
        return `
          <div style="padding: 2rem;">
            <div style="margin-bottom: 2rem;">
              <div style="display: inline-block; background: rgba(73, 212, 147, 0.15); color: var(--accent-green); padding: 0.5rem 1rem; border-radius: 999px; font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem;">
                <i class="fas fa-shield-check"></i> AUTOMATED
              </div>
              <h2 style="font-size: 2rem; margin-bottom: 0.5rem;"><i class="fas fa-${card.icon}"></i> ${card.title}</h2>
              <p style="color: var(--text-muted); font-size: 1.1rem;">Verifying readiness for execution</p>
            </div>

            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; margin-bottom: 2rem;">
              <div style="background: rgba(73, 212, 147, 0.08); border: 1px solid rgba(73, 212, 147, 0.3); border-radius: 12px; padding: 1.5rem;">
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                  <i class="fas fa-check-circle" style="color: var(--accent-green); font-size: 1.5rem;"></i>
                  <strong style="font-size: 1.1rem;">Contract Signed</strong>
                </div>
                <div style="font-size: 0.9rem; color: var(--text-muted);">
                  Customer signature received
                </div>
              </div>

              <div style="background: rgba(73, 212, 147, 0.08); border: 1px solid rgba(73, 212, 147, 0.3); border-radius: 12px; padding: 1.5rem;">
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                  <i class="fas fa-check-circle" style="color: var(--accent-green); font-size: 1.5rem;"></i>
                  <strong style="font-size: 1.1rem;">Payment Verified</strong>
                </div>
                <div style="font-size: 0.9rem; color: var(--text-muted);">
                  â‚¬${so.payment.paidAmount} confirmed
                </div>
              </div>

              <div style="background: rgba(73, 212, 147, 0.08); border: 1px solid rgba(73, 212, 147, 0.3); border-radius: 12px; padding: 1.5rem;">
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                  <i class="fas fa-check-circle" style="color: var(--accent-green); font-size: 1.5rem;"></i>
                  <strong style="font-size: 1.1rem;">Provider Confirmed</strong>
                </div>
                <div style="font-size: 0.9rem; color: var(--text-muted);">
                  Rui Lopes crew assigned
                </div>
              </div>

              <div style="background: rgba(73, 212, 147, 0.08); border: 1px solid rgba(73, 212, 147, 0.3); border-radius: 12px; padding: 1.5rem;">
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                  <i class="fas fa-check-circle" style="color: var(--accent-green); font-size: 1.5rem;"></i>
                  <strong style="font-size: 1.1rem;">Stock Available</strong>
                </div>
                <div style="font-size: 0.9rem; color: var(--text-muted);">
                  Products ready for delivery
                </div>
              </div>
            </div>

            <div style="background: rgba(73, 212, 147, 0.15); border: 2px solid var(--accent-green); border-radius: 12px; padding: 2rem; text-align: center; margin-bottom: 2rem;">
              <i class="fas fa-check-circle" style="font-size: 4rem; color: var(--accent-green); margin-bottom: 1rem;"></i>
              <h3 style="font-size: 1.5rem; color: var(--accent-green); margin-bottom: 0.5rem;">GO-GATE APPROVED</h3>
              <p style="color: var(--text-muted);">All conditions met. Service ready for execution.</p>
            </div>

            <div style="display: flex; justify-content: space-between; gap: 1rem;">
              <button class="btn btn-secondary" onclick="dashboard.previousCard()">
                <i class="fas fa-arrow-left"></i> Back
              </button>
              <button class="btn btn-primary" onclick="dashboard.nextCard()">
                Dispatch to Crew <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>
        `;
      };

      const renderCrewExecutionCard = (so, card) => {
        return `
          <div style="padding: 2rem;">
            <div style="margin-bottom: 2rem;">
              <div style="display: inline-block; background: rgba(78, 168, 255, 0.15); color: var(--accent-blue); padding: 0.5rem 1rem; border-radius: 999px; font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem;">
                <i class="fas fa-hard-hat"></i> CREW
              </div>
              <h2 style="font-size: 2rem; margin-bottom: 0.5rem;"><i class="fas fa-${card.icon}"></i> Crew Mobile App</h2>
              <p style="color: var(--text-muted); font-size: 1.1rem;">Rui Lopes - Crew Lead</p>
            </div>

            <div class="mobile-screen" style="max-width: 400px; margin: 0 auto 2rem; background: #000; border-radius: 32px; padding: 1.5rem 1rem; box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
              <div style="text-align: center; margin-bottom: 1.5rem;">
                <div style="font-size: 1.3rem; font-weight: 700;">Today's Job</div>
              </div>

              <div style="background: linear-gradient(135deg, #49d493, #38a169); color: #fff; padding: 1.5rem; border-radius: 16px; margin-bottom: 1rem;">
                <div style="font-size: 0.85rem; font-weight: 600; text-transform: uppercase; margin-bottom: 0.5rem;">
                  <i class="fas fa-check-circle"></i> Checked In
                </div>
                <div style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.3rem;">Job #SRV-${so.orderId.split('-')[2]}</div>
                <div style="font-size: 0.9rem;">Started 09:03 â€¢ Est. 11:00</div>
              </div>

              <div style="background: rgba(255,255,255,0.1); padding: 1.5rem; border-radius: 16px; margin-bottom: 1rem;">
                <div style="font-size: 1.1rem; font-weight: 700; margin-bottom: 1rem;">${so.customer.name}</div>
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                  <i class="fas fa-map-marker-alt" style="color: var(--accent-blue);"></i>
                  <span>${so.customer.city}</span>
                </div>

                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; margin-bottom: 1rem;">
                  <button style="padding: 0.8rem; background: rgba(73, 212, 147, 0.2); color: var(--accent-green); border: 1px solid var(--accent-green); border-radius: 8px; font-size: 0.85rem; font-weight: 600;">
                    <i class="fas fa-camera"></i> Photo (4)
                  </button>
                  <button style="padding: 0.8rem; background: rgba(78, 168, 255, 0.2); color: var(--accent-blue); border: 1px solid var(--accent-blue); border-radius: 8px; font-size: 0.85rem; font-weight: 600;">
                    <i class="fas fa-sticky-note"></i> Notes
                  </button>
                  <button style="padding: 0.8rem; background: rgba(192, 132, 252, 0.2); color: var(--accent-purple); border: 1px solid var(--accent-purple); border-radius: 8px; font-size: 0.85rem; font-weight: 600;">
                    <i class="fas fa-microphone"></i> Audio
                  </button>
                  <button style="padding: 0.8rem; background: rgba(251, 191, 36, 0.2); color: var(--accent-orange); border: 1px solid var(--accent-orange); border-radius: 8px; font-size: 0.85rem; font-weight: 600;">
                    <i class="fas fa-check-square"></i> Checklist
                  </button>
                </div>

                <div style="background: rgba(73, 212, 147, 0.2); padding: 0.8rem; border-radius: 8px; text-align: center;">
                  <div style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.3rem; color: var(--accent-green);">âœ“ 4/4</div>
                  <div style="font-size: 0.85rem; color: #ccc;">Tasks Completed</div>
                </div>
              </div>
            </div>

            <div style="display: flex; justify-content: space-between; gap: 1rem;">
              <button class="btn btn-secondary" onclick="dashboard.previousCard()">
                <i class="fas fa-arrow-left"></i> Back
              </button>
              <button class="btn btn-primary" onclick="dashboard.nextCard()">
                <i class="fas fa-check-double"></i> Check Out & Request WCF <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>
        `;
      };

      const renderWCFNotificationCard = (so, card) => {
        return `
          <div style="padding: 2rem;">
            <div style="margin-bottom: 2rem;">
              <div style="display: inline-block; background: rgba(78, 168, 255, 0.15); color: var(--accent-blue); padding: 0.5rem 1rem; border-radius: 999px; font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem;">
                <i class="fas fa-user"></i> CUSTOMER
              </div>
              <h2 style="font-size: 2rem; margin-bottom: 0.5rem;"><i class="fas fa-${card.icon}"></i> ${card.title}</h2>
              <p style="color: var(--text-muted); font-size: 1.1rem;">Email & SMS sent to ${so.customer.name}</p>
            </div>

            <div class="email-mockup" style="background: #fff; color: #333; border-radius: 12px; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.3); max-width: 600px; margin: 0 auto 2rem;">
              <div class="email-header" style="padding: 1.5rem; border-bottom: 1px solid #e5e5e5;">
                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                  <div style="background: var(--yellow); color: #1a1a1a; padding: 0.5rem 1rem; font-weight: 700; border-radius: 4px;">YellowGrid</div>
                  <div style="flex: 1;"></div>
                  <div style="font-size: 0.85rem; color: #666;">10:52 AM</div>
                </div>
                <div style="font-size: 1.1rem; font-weight: 700;">
                  Service Complete - Please Sign WCF
                </div>
              </div>
              <div class="email-body" style="padding: 1.5rem;">
                <p>Dear ${so.customer.firstName},</p>
                <p style="margin: 1rem 0;">Your service <strong>${so.services[0].name}</strong> has been completed. Please sign the Work Completion Form.</p>
                <div style="text-align: center; margin: 1.5rem 0;">
                  <div style="background: var(--accent-green); color: #fff; padding: 1rem 2rem; border-radius: 8px; display: inline-block; font-weight: 700; cursor: pointer;">
                    <i class="fas fa-signature"></i> Sign WCF Online
                  </div>
                </div>
              </div>
            </div>

            <div style="display: flex; justify-content: space-between; gap: 1rem;">
              <button class="btn btn-secondary" onclick="dashboard.previousCard()">
                <i class="fas fa-arrow-left"></i> Back
              </button>
              <button class="btn btn-primary" onclick="dashboard.nextCard()">
                Customer Opens Email <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>
        `;
      };

      const renderWCFPortalCard = (so, card) => {
        return `
          <div style="padding: 2rem;">
            <div style="margin-bottom: 2rem;">
              <div style="display: inline-block; background: rgba(78, 168, 255, 0.15); color: var(--accent-blue); padding: 0.5rem 1rem; border-radius: 999px; font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem;">
                <i class="fas fa-user"></i> CUSTOMER
              </div>
              <h2 style="font-size: 2rem; margin-bottom: 0.5rem;"><i class="fas fa-${card.icon}"></i> Work Completion Form</h2>
              <p style="color: var(--text-muted); font-size: 1.1rem;">${so.customer.name} reviewing completed work</p>
            </div>

            <div style="background: rgba(255, 255, 255, 0.03); border: 2px solid var(--border); border-radius: 12px; padding: 2rem; max-width: 800px; margin: 0 auto 2rem;">
              <div style="text-align: center; margin-bottom: 2rem;">
                <h3 style="font-size: 1.8rem; margin-bottom: 0.5rem;">Work Completion Form</h3>
                <p style="color: var(--text-muted);">Service Order: <strong>SRV-${so.orderId.split('-')[2]}</strong></p>
              </div>

              <div style="background: rgba(73, 212, 147, 0.08); border: 2px solid rgba(73, 212, 147, 0.4); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                  <i class="fas fa-check-circle" style="font-size: 2.5rem; color: var(--accent-green);"></i>
                  <div style="flex: 1;">
                    <strong style="font-size: 1.2rem; color: var(--accent-green);">Sign with No Reserves</strong>
                    <p style="font-size: 0.9rem; color: var(--text-muted); margin: 0.3rem 0 0 0;">Work completed satisfactorily. Payment releases immediately.</p>
                  </div>
                </div>
              </div>

              <div style="border: 2px dashed var(--border); border-radius: 8px; padding: 1.5rem; text-align: center; margin-bottom: 1.5rem;">
                <i class="fas fa-signature" style="font-size: 2rem; color: var(--yellow); margin-bottom: 0.5rem;"></i>
                <div style="font-size: 1.2rem; font-style: italic; margin-top: 1rem;">${so.customer.name}</div>
                <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem;">Signed: ${new Date().toLocaleDateString('en-GB')}</div>
              </div>
            </div>

            <div style="display: flex; justify-content: space-between; gap: 1rem;">
              <button class="btn btn-secondary" onclick="dashboard.previousCard()">
                <i class="fas fa-arrow-left"></i> Back
              </button>
              <div style="text-align: center; flex: 1;">
                <button class="btn btn-primary" style="font-size: 1.2rem; padding: 1rem 2rem;" onclick="alert('ðŸŽ‰ Journey Complete! Service order closed successfully.')">
                  <i class="fas fa-signature"></i> Sign WCF & Complete Journey
                </button>
                <div style="margin-top: 1rem; color: var(--accent-green);">
                  <i class="fas fa-check-circle"></i> <strong>Final Step</strong> - Service order will be closed
                </div>
              </div>
            </div>
          </div>
        `;
      };

      const renderInvoicePortalCard = (so, card) => {
        return `
          <div style="padding: 2rem;">
            <div style="margin-bottom: 2rem;">
              <div style="display: inline-block; background: rgba(251, 191, 36, 0.15); color: var(--accent-orange); padding: 0.5rem 1rem; border-radius: 999px; font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem;">
                <i class="fas fa-handshake"></i> PROVIDER
              </div>
              <h2 style="font-size: 2rem; margin-bottom: 0.5rem;"><i class="fas fa-${card.icon}"></i> ${card.title}</h2>
              <p style="color: var(--text-muted); font-size: 1.1rem;">Provider L - Rui Lopes</p>
            </div>

            <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border); border-radius: 12px; padding: 2rem; margin-bottom: 2rem;">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 2rem;">
                <div>
                  <h3 style="margin-bottom: 0.5rem;"><i class="fas fa-file-invoice"></i> Pro Forma Invoice</h3>
                  <div style="font-size: 0.9rem; color: var(--text-muted);">Auto-generated after service completion</div>
                </div>
                <div style="text-align: right;">
                  <div style="font-size: 0.85rem; color: var(--text-muted);">Invoice #</div>
                  <div style="font-size: 1.2rem; font-weight: 700;">INV-2024-${so.orderId.split('-')[2]}</div>
                </div>
              </div>

              <div style="background: rgba(255,255,255,0.02); border: 1px solid var(--border); border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
                <div style="display: flex; justify-content: space-between; padding-bottom: 0.8rem; border-bottom: 1px solid var(--border);">
                  <span>Service Description</span>
                  <span>Amount</span>
                </div>
                <div style="padding: 0.8rem 0; border-bottom: 1px solid var(--border);">
                  <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span>${so.services[0].name}</span>
                    <span style="font-weight: 600;">â‚¬${so.services[0].price}</span>
                  </div>
                  <div style="font-size: 0.85rem; color: var(--text-muted);">Date: ${so.services[0].scheduledDate} â€¢ Duration: ${so.services[0].duration} min</div>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 0.8rem 0; border-bottom: 1px solid var(--border);">
                  <span style="color: var(--text-muted);">Equipment & Materials</span>
                  <span style="font-weight: 600;">â‚¬45.00</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 0.8rem 0; border-bottom: 1px solid var(--border);">
                  <span style="color: var(--text-muted);">Travel Expenses</span>
                  <span style="font-weight: 600;">â‚¬12.50</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 0.8rem 0; border-bottom: 1px solid var(--border);">
                  <span style="color: var(--text-muted);">Subtotal</span>
                  <span style="font-weight: 600;">â‚¬${(parseFloat(so.services[0].price) + 57.50).toFixed(2)}</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 0.8rem 0; border-bottom: 1px solid var(--border);">
                  <span style="color: var(--text-muted);">VAT (23%)</span>
                  <span style="font-weight: 600;">â‚¬${((parseFloat(so.services[0].price) + 57.50) * 0.23).toFixed(2)}</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding-top: 1rem;">
                  <span style="font-size: 1.2rem; font-weight: 700;">Total Amount</span>
                  <span style="font-size: 1.5rem; font-weight: 700; color: var(--yellow);">â‚¬${((parseFloat(so.services[0].price) + 57.50) * 1.23).toFixed(2)}</span>
                </div>
              </div>

              <div style="display: flex; gap: 1rem;">
                <button class="btn btn-primary" style="flex: 1; background: var(--accent-green);">
                  <i class="fas fa-check"></i> Accept Invoice
                </button>
                <button class="btn btn-secondary" style="flex: 1; background: rgba(255, 82, 82, 0.2); color: var(--accent-red);">
                  <i class="fas fa-exclamation-triangle"></i> Contest Invoice
                </button>
              </div>
            </div>

            <div style="display: flex; justify-content: flex-end; gap: 1rem;">
              <button class="btn btn-secondary" onclick="dashboard.previousCard()">
                <i class="fas fa-arrow-left"></i> Back
              </button>
              <button class="btn btn-primary" onclick="dashboard.nextCard()">
                Invoice Accepted <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>
        `;
      };

      const renderInvoiceDataflowCard = (so, card) => {
        return `
          <div style="padding: 2rem;">
            <div style="margin-bottom: 2rem;">
              <div style="display: inline-block; background: rgba(78, 168, 255, 0.15); color: var(--accent-blue); padding: 0.5rem 1rem; border-radius: 999px; font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem;">
                <i class="fas fa-exchange-alt"></i> SYSTEM
              </div>
              <h2 style="font-size: 2rem; margin-bottom: 0.5rem;"><i class="fas fa-${card.icon}"></i> ${card.title}</h2>
              <p style="color: var(--text-muted); font-size: 1.1rem;">Invoice processing and payment signals</p>
            </div>

            <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border); border-radius: 12px; padding: 2rem; margin-bottom: 2rem;">
              <h3 style="margin-bottom: 1.5rem;"><i class="fas fa-stream"></i> Invoice Dataflow</h3>

              <div style="position: relative; padding-left: 2rem;">
                <div style="position: absolute; left: 0.75rem; top: 0; bottom: 0; width: 2px; background: linear-gradient(to bottom, var(--accent-green), var(--accent-blue), var(--yellow));"></div>

                <div style="position: relative; margin-bottom: 2rem;">
                  <div style="position: absolute; left: -1.4rem; width: 24px; height: 24px; background: var(--accent-green); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-check" style="font-size: 0.7rem;"></i>
                  </div>
                  <div style="background: rgba(73, 212, 147, 0.1); border: 1px solid rgba(73, 212, 147, 0.3); border-radius: 8px; padding: 1rem;">
                    <div style="font-weight: 700; margin-bottom: 0.5rem; color: var(--accent-green);">
                      <i class="fas fa-file-invoice"></i> Invoice Received from Provider
                    </div>
                    <div style="font-size: 0.85rem; color: var(--text-muted);">Pro forma invoice INV-2024-${so.orderId.split('-')[2]} â€¢ â‚¬${((parseFloat(so.services[0].price) + 57.50) * 1.23).toFixed(2)}</div>
                  </div>
                </div>

                <div style="position: relative; margin-bottom: 2rem;">
                  <div style="position: absolute; left: -1.4rem; width: 24px; height: 24px; background: var(--accent-blue); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-check" style="font-size: 0.7rem;"></i>
                  </div>
                  <div style="background: rgba(78, 168, 255, 0.1); border: 1px solid rgba(78, 168, 255, 0.3); border-radius: 8px; padding: 1rem;">
                    <div style="font-weight: 700; margin-bottom: 0.5rem; color: var(--accent-blue);">
                      <i class="fas fa-robot"></i> Payment Signal Generated
                    </div>
                    <div style="font-size: 0.85rem; color: var(--text-muted);">Payment scheduled for T+30 days â€¢ Expected: ${new Date(Date.now() + 30*24*60*60*1000).toLocaleDateString()}</div>
                  </div>
                </div>

                <div style="position: relative;">
                  <div style="position: absolute; left: -1.4rem; width: 24px; height: 24px; background: var(--yellow); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-check" style="font-size: 0.7rem; color: #000;"></i>
                  </div>
                  <div style="background: rgba(255, 203, 50, 0.1); border: 1px solid rgba(255, 203, 50, 0.3); border-radius: 8px; padding: 1rem;">
                    <div style="font-weight: 700; margin-bottom: 0.5rem; color: var(--yellow);">
                      <i class="fas fa-bell"></i> Provider Notification Sent
                    </div>
                    <div style="font-size: 0.85rem; color: var(--text-muted);">Payment confirmation dispatched to provider portal</div>
                  </div>
                </div>
              </div>
            </div>

            <div style="display: flex; justify-content: flex-end; gap: 1rem;">
              <button class="btn btn-secondary" onclick="dashboard.previousCard()">
                <i class="fas fa-arrow-left"></i> Back
              </button>
              <button class="btn btn-primary" onclick="dashboard.nextCard()">
                View Payment Status <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>
        `;
      };

      const renderPaymentPortalCard = (so, card) => {
        return `
          <div style="padding: 2rem;">
            <div style="margin-bottom: 2rem;">
              <div style="display: inline-block; background: rgba(251, 191, 36, 0.15); color: var(--accent-orange); padding: 0.5rem 1rem; border-radius: 999px; font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem;">
                <i class="fas fa-handshake"></i> PROVIDER
              </div>
              <h2 style="font-size: 2rem; margin-bottom: 0.5rem;"><i class="fas fa-${card.icon}"></i> ${card.title}</h2>
              <p style="color: var(--text-muted); font-size: 1.1rem;">Provider L - Rui Lopes</p>
            </div>

            <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border); border-radius: 12px; padding: 2rem; margin-bottom: 2rem;">
              <h3 style="margin-bottom: 1.5rem;"><i class="fas fa-money-check-alt"></i> Payment Dashboard</h3>

              <div style="background: linear-gradient(135deg, rgba(73, 212, 147, 0.15), rgba(73, 212, 147, 0.05)); border: 1px solid var(--accent-green); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
                <div style="text-align: center;">
                  <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.5rem;">TOTAL PENDING</div>
                  <div style="font-size: 2.5rem; font-weight: 700; color: var(--accent-green); margin-bottom: 0.3rem;">â‚¬${((parseFloat(so.services[0].price) + 57.50) * 1.23).toFixed(2)}</div>
                  <div style="font-size: 0.9rem; color: var(--text-muted);">1 invoice â€¢ Payment date: ${new Date(Date.now() + 30*24*60*60*1000).toLocaleDateString()}</div>
                </div>
              </div>

              <div style="background: rgba(255,255,255,0.02); border: 1px solid var(--border); border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                  <div>
                    <div style="font-weight: 700; margin-bottom: 0.3rem;">INV-2024-${so.orderId.split('-')[2]}</div>
                    <div style="font-size: 0.85rem; color: var(--text-muted);">${so.services[0].name}</div>
                  </div>
                  <div style="text-align: right;">
                    <div style="font-size: 1.3rem; font-weight: 700;">â‚¬${((parseFloat(so.services[0].price) + 57.50) * 1.23).toFixed(2)}</div>
                  </div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">
                  <div>
                    <div style="font-size: 0.75rem; color: var(--text-muted);">STATUS</div>
                    <div style="font-weight: 600; color: var(--yellow);">
                      <i class="fas fa-clock"></i> Scheduled
                    </div>
                  </div>
                  <div>
                    <div style="font-size: 0.75rem; color: var(--text-muted);">PAYMENT DATE</div>
                    <div style="font-weight: 600;">${new Date(Date.now() + 30*24*60*60*1000).toLocaleDateString()}</div>
                  </div>
                  <div>
                    <div style="font-size: 0.75rem; color: var(--text-muted);">METHOD</div>
                    <div style="font-weight: 600;">Bank Transfer</div>
                  </div>
                </div>
              </div>

              <div style="background: rgba(73, 212, 147, 0.08); border: 1px solid rgba(73, 212, 147, 0.3); border-radius: 8px; padding: 1rem;">
                <div style="font-size: 0.9rem;">
                  <i class="fas fa-history" style="color: var(--accent-green);"></i>
                  <strong style="color: var(--accent-green);"> Historical Data:</strong>
                  <span style="color: var(--text-muted);"> 24 invoices paid â€¢ Avg. 28 days â€¢ 100% payment rate</span>
                </div>
              </div>
            </div>

            <div style="display: flex; justify-content: space-between; gap: 1rem;">
              <button class="btn btn-secondary" onclick="dashboard.previousCard()">
                <i class="fas fa-arrow-left"></i> Back
              </button>
              <div style="text-align: center; flex: 1;">
                <button class="btn btn-primary" style="font-size: 1.2rem; padding: 1rem 2rem;" onclick="alert('ðŸŽ‰ Journey Complete! End-to-end workflow from Kafka to Payment.')">
                  <i class="fas fa-flag-checkered"></i> Complete Journey
                </button>
                <div style="margin-top: 1rem; color: var(--accent-green);">
                  <i class="fas fa-check-circle"></i> <strong>Full Lifecycle</strong> - From ingestion to payment
                </div>
              </div>
            </div>
          </div>
        `;
      };

      const renderMetroLine = () => {
        const html = allCards.map((card, idx) => {
          const isActive = idx === currentCardIndex;
          const isCompleted = idx < currentCardIndex;
          const dotClass = isActive ? 'active' : (isCompleted ? 'completed' : '');
          const lineClass = isCompleted ? 'completed' : '';
          
          return `
            <div class="metro-station">
              <div class="station-dot ${dotClass}" onclick="dashboard.goToCard(${idx})" title="${card.title}">
                <i class="fas fa-${card.icon}"></i>
                <div class="station-label">${card.title}</div>
              </div>
              ${idx < allCards.length - 1 ? `<div class="station-line ${lineClass}"></div>` : ''}
            </div>
          `;
        }).join('');
        
        document.getElementById('metroLine').innerHTML = html;
      };

      const renderCard = () => {
        const card = allCards[currentCardIndex];
        if (!card) return;

        const so = scenarios[currentScenario].salesOrder;
        let html = '';

        // Render different card types
        if (card.id === 'kafka-message') {
          html = renderKafkaMessageCard(so, card);
        } else if (card.id === 'enrichment') {
          html = renderEnrichmentCard(so, card);
        } else if (card.id === 'project-creation') {
          html = renderProjectCreationCard(so, card);
        } else if (card.id === 'ai-reasoning') {
          html = renderAIReasoningCard(so, card);
        } else if (card.id === 'operator-cockpit') {
          html = renderOperatorCockpitCard(so, card);
        } else if (card.id === 'contract-notification') {
          html = renderContractNotificationCard(so, card);
        } else if (card.id === 'contract-portal') {
          html = renderContractPortalCard(so, card);
        } else if (card.id === 'match-request') {
          html = renderMatchRequestCard(so, card);
        } else if (card.id === 'provider-funnel') {
          html = renderProviderFunnelCard(so, card);
        } else if (card.id === 'provider-offer') {
          html = renderProviderOfferCard(so, card);
        } else if (card.id === 'go-gate-check') {
          html = renderGoGateCard(so, card);
        } else if (card.id === 'crew-execution') {
          html = renderCrewExecutionCard(so, card);
        } else if (card.id === 'wcf-notification') {
          html = renderWCFNotificationCard(so, card);
        } else if (card.id === 'wcf-portal') {
          html = renderWCFPortalCard(so, card);
        } else if (card.id === 'invoice-portal') {
          html = renderInvoicePortalCard(so, card);
        } else if (card.id === 'invoice-dataflow') {
          html = renderInvoiceDataflowCard(so, card);
        } else if (card.id === 'payment-portal') {
          html = renderPaymentPortalCard(so, card);
        }

        document.getElementById('journeyCard').innerHTML = html;
      };

      const loadScenario = (scenarioId) => {
        if (!scenarioId) return;
        currentScenario = scenarioId;
        currentCardIndex = 0;
        renderMetroLine();
        renderCard();
      };

      const nextCard = () => {
        if (currentCardIndex < allCards.length - 1) {
          currentCardIndex++;
          renderMetroLine();
          renderCard();
        }
      };

      const previousCard = () => {
        if (currentCardIndex > 0) {
          currentCardIndex--;
          renderMetroLine();
          renderCard();
        }
      };

      const goToCard = (index) => {
        if (index >= 0 && index < allCards.length) {
          currentCardIndex = index;
          renderMetroLine();
          renderCard();
        }
      };

      const nextStep = () => {
        nextCard(); // Keep for backward compatibility with button
      };

      window.dashboard = {
        loadScenario,
        nextStep,
        nextCard,
        previousCard,
        goToCard
      };
    })();
  </script>
</body>
</html>
